function makeSheet(t,i,s){return{w:i,h:s,cellW:Math.ceil(t.width/i),cellH:Math.ceil(t.height/s),render:function(e,h,n,a,r){e.drawImage(t,h*i,n*s,i,s,a,r,i,s)}}}var utils={snap:function(t,i){return Math.floor(t/i)*i},anim:function(){return function(){}},checkCollision:function(t,i,s){var e,h,n,a,r=t,s=s||"hit",o=i.length;for(e=0;o>e;e++)h=i[e],n=r.x+(r.xbb||0),a=h.x+(h.xbb||0),r!==h&&n+r.w>=a&&n<=a+h.w&&r.y+r.h>=h.y&&r.y<=h.y+h.h&&(r[s]&&r[s](h),h[s]&&h[s](r))},checkCollisions:function(t,i){var s,e,h,n,i=i||"hit",a=t.reduce(function(t,i){return Array.isArray(i)?t.concat(i):(t.push(i),t)},[]),r=a.length;for(s=0;r-1>s;s++)for(h=a[s],e=s+1;r>e;e++)n=a[e],h!==n&&h.x+h.w>=n.x&&h.x<=n.x+n.w&&h.y+h.h>=n.y&&h.y<=n.y+n.h&&(h[i]&&h[i](n),n[i]&&n[i](h))},createCanvas:function(t,i,s){var e=document.createElement("canvas"),h=e.getContext("2d");return h.imageSmoothingEnabled=!1,h.mozImageSmoothingEnabled=!1,h.webkitImageSmoothingEnabled=!1,h.w=t,h.h=i,e.setAttribute("height",i),e.setAttribute("width",t),s&&e.setAttribute("id",s),h},dist:function(t,i){var s=t[0]-i[0],e=t[1]-i[1];return Math.sqrt(s*s+e*e)},angleBetween:function(t,i){var s=t.x-i.x,e=t.y-i.y,h=Math.atan2(e,s);return h%Math.PI}};window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame,function(){function t(){var t=s.createBuffer(1,.5*s.sampleRate,s.sampleRate),e=t.getChannelData(0);for(i=0;i<e.length;i++)e[i]=(2*Math.random()-1)/2;var h=s.createBufferSource();return h.buffer=t,h.loop=!0,h}var s;window.audio={sfx:{jump:function(){var t=s.currentTime,i=s.createOscillator(),e=s.createBiquadFilter(),h=s.createGain();i.connect(e),e.connect(h),h.connect(audio.master),h.gain.value=.12,e.frequency.value=2e3,e.Q.value=10,i.type="sine",i.frequency.value=0,i.frequency.setValueAtTime(300,t),i.frequency.linearRampToValueAtTime(600,t+.1),i.start(0),i.stop(t+.1)},shoot:function(){var i=s.currentTime,e=t(),h=s.createBiquadFilter();h.connect(audio.master),h.Q.value=20;var n=0|2e3*Math.random()+500;h.frequency.value=n,h.frequency.setValueAtTime(n,i),h.frequency.linearRampToValueAtTime(100,i+.02),e.connect(h),e.start(0),e.stop(i+.04)},pickup:function(){var t=s.currentTime,i=s.createOscillator(),e=s.createBiquadFilter(),h=s.createGain();i.connect(e),e.connect(h),h.connect(audio.master),h.gain.value=.15,e.frequency.value=3e3,e.Q.value=10,i.type="sine",i.frequency.value=0,i.frequency.setValueAtTime(600,t),i.frequency.linearRampToValueAtTime(2600,t+.12),i.start(0),i.stop(t+.12)}},init:function(){this.ctx=s=new(window.AudioContext||window.webkitAudioContext),this.master=s.createGain(),this.master.gain.value=.5,this.master.connect(s.destination),this.createTune()},stop:function(){this.osc.stop(s.currentTime)},createTune:function(){return}}}();var GEN={tiles:function(t,i){var s,e,h,n,a,r,o,l,c,u,f,p=20;for(e=utils.createCanvas(p*t,i),h=e.createImageData(e.w,e.h),s=0;p>s;s++)for(a=0;i>a;a++)for(n=0;t>n;n++){switch(r=4*n+4*a*e.w+4*s*t,o=16711935,u=255-(0|96*Math.random()),s){case 5:case 11:case 12:if(o=7426359,(3&3*n*n+41*n>>2)+8>a?o=6990400:(3&3*n*n+41*n>>2)+9>a&&(u=2*u/3),11===s&&2>n&&2>a){c=Math.sqrt((2-n)*(2-n)+(2-a)*(2-a)),c>=1.8&&(o=-1);break}if(12===s&&n>17&&2>a){c=Math.sqrt((17-n)*(17-n)+(2-a)*(2-a)),c>=1.9&&(o=-1);break}break;case 7:o=7426359;break;case 6:o=8355711;break;case 1:o=Math.random()<.15?5298487:-1,(1==(n+16*(a>>2))%8||0==a%8)&&(o=14795897);break;case 2:case 3:case 4:o=4948931,f=a%12-4*(s-2),0>f&&(f+=12),Math.abs(0|5*Math.sin(n/2))===f&&(o=16777215);break;case 8:case 9:case 10:o=16685824,f=a%4-(s-8),0>f&&(f+=4),Math.abs(0|2*Math.sin(n/2))===f&&(o=14756096),u=Math.min(255,1.4*u)}l=(255&o>>16)*u/255<<16|(255&o>>8)*u/255<<8|(255&o)*u/255,h.data[r+0]=-1==o?0:255&l>>16,h.data[r+1]=-1==o?0:255&l>>8,h.data[r+2]=-1==o?0:255&l,h.data[r+3]=-1==o?0:255}return e.putImageData(h,0,0),e.canvas},font:function(){var t,i=utils.createCanvas(720,24),s=utils.createCanvas(720,24),e="ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890!?.:;,/'",h=e.split("");i.fillStyle="#fff",i.font="24px courier new",h.forEach(function(t,s){i.fillText(t,16*s,16)});for(var n=i.getImageData(0,0,i.canvas.width,i.canvas.height),a=s.getImageData(0,0,s.canvas.width,s.canvas.height),r=1,o=0;o<n.height;o++)for(var l=0;l<n.width;l++){var c=0|2.5*(0|l/2.5),u=0|2.5*(0|o/2.5),f=[n.data[4*(u*n.width+c)+0],n.data[4*(u*n.width+c)+1],n.data[4*(u*n.width+c)+2],n.data[4*(u*n.width+c)+3]];f[3]<20?f[3]>100?(f[0]=255,f[1]=255,f[2]=0,f[3]=155):f[3]=0:f[3]=255;for(var p=0;r>p;p++)for(var y=o*r+p,d=0;r>d;d++)for(var w=l*r+d,m=0;4>m;m++)a.data[4*(y*a.width+w)+m]=f[m]}return s.putImageData(a,0,0),t=makeSheet(s.canvas,16,24),function(i,s,e,n){s.split("").forEach(function(s,a){return" "!==s&&t.render(i,h.indexOf(s),0,e+16*a,n),!0})}}},BLOCKS={walkable:4,type:{LADDER:1,WATER:2,WATERRIGHT:3,WATERLEFT:4,LAVA:8}};window.BLOCKS=BLOCKS,function(){var t;window.Map={x:0,y:0,init:function(i,s){return this.sheet=i,this.camera=s,this.cells=this.expandRoomMap(t,this.generateRoomMap()),this.pickups=this.addPickups(),this.pieces=this.addPieces(),this.walkable=BLOCKS.walkable,this.cellH=this.cells.length,this.cellW=this.cells[0].length,this.h=this.cellH*i.h,this.w=this.cellW*i.w,this.camera.setBounds(this.w,this.h),this},generateRoomMap:function(){for(var i=[],s=0;12>s;s++){i.push([]);for(var e=0;15>e;e++)i[s].push(0|Math.random()*t.length)}return i},expandRoomMap:function(t,i){var s,e,h,n=[],a=i.length,r=i[0].length,o=t[0][0].length,l=t[0].length;for(h=0;a*l+2>h;h++)for(n.push([]),e=0;r*o>e;e++)a*l>h?(s=i[0|h/l][0|e/o],n[h].push(t[s][h%l][e%o])):n[h].push(6);return n},addPickups:function(){for(var t=[],i=0;60>i;i++)t.push([0|Math.random()*this.cells[0].length,0|Math.random()*this.cells.length]);return t},addPieces:function(){for(var t=[],i=0;4>i;i++)t.push([0|Math.random()*this.cells[0].length,0|Math.random()*this.cells.length]);return t},tick:function(){},getBlocks:function(t){return t.map(function(t){var i=0|t[1]/this.sheet.h,s=0|t[0]/this.sheet.w;return 0>i||i>this.cellH-1?null:this.cells[i][s]},this)},getBlockEdge:function(t,i){var s=i?this.sheet.h:this.sheet.w;return utils.snap(t,s)},render:function(t){var i,s,e,h=game.tw,n=game.th,a=this.sheet.cellW,r=(this.sheet.cellH,0|this.camera.x/h),o=0|this.camera.y/n,l=r+(0|this.camera.w/h)+1,c=o+(0|this.camera.h/n)+1;for(i=o;c>=i;i++)if(!(0>i||i>this.cellH-1))for(s=r;l>=s;s++)s>this.cellW-1||(e=this.cells[i][s],0!==e&&(e>=2&&4>=e&&(e=(0|Date.now()/200%3)+2),e>=8&&10>=e&&(e=(0|Date.now()/400%3)+8),this.sheet.render(t,0|e%a,0|e/a,s*h,i*n)))}},t=[[[0,0,0,1,1,0,0,0,1,1,0],[0,0,0,1,1,1,1,1,1,1,0],[0,0,0,1,1,1,1,1,1,1,0],[0,0,0,1,0,0,0,0,0,1,0],[0,0,0,0,0,5,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0],[5,1,5,5,5,5,5,5,1,5,5]],[[0,0,0,0,0,0,0,0,0,0,0],[0,12,0,0,0,0,0,0,0,0,0],[5,8,12,0,0,0,0,0,6,1,6],[7,8,8,12,0,0,0,0,0,1,0],[7,8,8,8,12,0,0,0,0,1,0],[7,0,8,8,8,12,0,0,0,1,0],[0,0,5,5,5,5,5,5,5,1,5]],[[0,0,0,0,0,0,0,0,0,0,1],[0,0,0,0,0,0,0,0,0,0,1],[0,0,0,0,6,6,0,0,0,0,1],[0,0,0,0,0,6,6,6,0,0,0],[0,0,0,0,0,0,0,0,0,0,0],[5,5,5,5,5,5,5,5,5,5,0],[7,7,7,7,7,7,7,7,7,7,1]],[[0,0,0,0,0,0,2,0,0,0,7],[0,0,0,0,0,0,2,0,0,11,7],[6,1,1,0,0,0,3,3,3,2,7],[0,1,1,0,0,0,7,7,7,2,7],[0,1,1,0,0,11,7,7,7,2,7],[5,1,1,5,5,7,7,2,4,4,7],[7,7,1,7,7,7,2,2,7,7,7]],[[7,0,0,0,0,0,0,0,0,0,1],[7,0,0,0,0,0,0,0,0,0,7],[7,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0],[7,0,0,5,12,0,0,0,0,0,5],[1,0,5,7,7,0,0,0,0,0,7],[1,5,7,7,7,0,5,5,5,1,7]],[[0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,5,5],[0,0,0,0,0,0,0,0,5,7,0],[0,0,0,0,0,0,0,5,7,0,0],[0,0,0,0,0,0,0,0,0,0,5],[0,0,5,5,12,0,0,0,0,0,7],[7,5,7,7,7,0,5,5,5,1,7]],[[0,0,0,0,5,5,5,0,0,0,0],[5,0,0,0,0,0,0,0,0,5,5],[0,0,0,0,0,0,0,0,5,7,0],[0,0,5,5,0,0,0,5,7,0,0],[0,0,0,0,5,5,0,0,0,0,5],[0,0,0,0,0,0,0,0,0,0,7],[0,0,0,0,0,0,0,0,0,0,0]]]}();var Entity=function(){this.w=10,this.h=10,this.remove=!1,this.falling=!1,this.xo=0,this.yo=0};Entity.prototype={init:function(t,i){return this.x=t,this.y=i,this},hit:function(){},hitBlocks:function(){},tick:function(){return!this.remove},move:function(t,i,s){var e,h,n,a,r,o,l=!1,c=!1;return e=t,h=i,n=this.x+e,a=this.y+h,o=s.getBlocks([[this.x,a],[this.x,a+(this.h-1)],[this.x+(this.w-1),a],[this.x+(this.w-1),a+(this.h-1)]]),0>i&&(o[0]>s.walkable||o[2]>s.walkable)&&(h=s.getBlockEdge((0|a)+s.sheet.h,"VERT")-this.y,c=!0),i>0&&(o[1]>s.walkable||o[3]>s.walkable)&&(h=s.getBlockEdge(a+this.h,"VERT")-this.y-this.h,c=!0),this.y+=h,r=s.getBlocks([[n,this.y],[n,this.y+(this.h-1)],[n+(this.w-1),this.y],[n+(this.w-1),this.y+(this.h-1)]]),0>t&&(r[0]>s.walkable||r[1]>s.walkable)&&(e=s.getBlockEdge(n+s.sheet.w)-this.x,l=!0),t>0&&(r[2]>s.walkable||r[3]>s.walkable)&&(e=s.getBlockEdge(n+this.w)-this.x-this.w,l=!0),(l||c)&&this.hitBlocks(l?r:null,c?o:null),this.x+=e,o=s.getBlocks([[this.x-(this.dir>0?6:0),this.y+this.h],[this.x+(this.w-1)+(this.dir<0?6:0),this.y+this.h]]),this.wasFalling=this.falling,this.falling=o[0]<=s.walkable&&o[1]<=s.walkable?this.onLadder?!1:!0:!1,this.xo=0,this.yo=0,[e,h]},render:function(t){t.fillStyle="red",t.fillRect(this.x,this.y,this.w,this.h)}};var Ghoul=function(){this.w=15,this.h=22,this.dir=1,this.speed=1.1,this.angrySpeed=1.5,this.life=3,this.knockBack=0,this.xpValue=5,this.isAngry=!1};Ghoul.prototype=new Entity,Ghoul.prototype.init=function(t,i,s,e){return this.x=t,this.y=i,this.level=e,this.dir=s||1,this.offs={headX:2,headY:-3,bodyX:0,bodyY:5},this},Ghoul.prototype.hit=function(t){t instanceof Spear&&!t.stuck&&(this.knockBack=t.dir===this.dir?5*t.dir:-12*this.dir,this.life--<=0&&(this.level.xp(this),this.remove=!0)),t instanceof Trap&&(this.remove=!0)},Ghoul.prototype.tick=function(t){var i,s=0,e=0;if(this.isAngry){i=this.level.player;var h=utils.dist([this.x,this.y],[i.x,i.y]);300>h&&(Math.abs(this.y-i.y)>2?s=this.angrySpeed*(this.y<i.y?1:-1):Math.abs(this.x-i.x)>5&&(this.dir=this.x<i.x?1:-1,e=this.angrySpeed*this.dir))}else s=Math.sin(Date.now()/100),e=this.speed*this.dir;return 0!==this.knockBack&&(e+=this.knockBack,this.knockBack=this.knockBack+(this.knockBack>0?-1:1)),this.isAngry?(this.x+=e,this.y+=s):this.move(e,s,t),!this.remove},Ghoul.prototype.hitBlocks=function(){this.dir*=-1},Ghoul.prototype.render=function(t){t.strokeStyle="hsl(70, 100%, 50%)",t.shadowColor="hsl(70, 100%, 50%)",t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=10,t.fillStyle=this.isAngry?"hsl(10, 80%, 60%)":"hsl(180, 80%, 50%)",t.fillRect(this.x+this.offs.bodyX,this.y+this.offs.bodyY,12,15),t.fillStyle=this.isAngry?"hsl(0, 80%, 60%)":"hsl(120, 30%, 40%)",t.fillRect(this.x+this.offs.headX*this.dir+3,this.y+this.offs.headY,6,10),t.fillStyle="hsl(120, 40%, 50%)",t.fillRect(this.x+2,this.y+20,8,3),t.fillRect(this.x+4,this.y+11,3,5)};var Player=function(){this.w=12,this.h=23,this.xp=0,this.vel=[0,0],this.acc=[0,0],this.grav=0,this.friction=.75,this.falling=!0,this.wasFalling=!1,this.onLadder=!1,this.wasOnLadder=!1,this.dir=1,this.numPickups=0,this.numTraps=0,this.pieces=[!1,!1,!1,!1],this.trapLaunch=-1};Player.prototype=new Entity,Player.prototype.init=function(t,i,s){return this.x=t,this.y=i,this.level=s,this.checkpoint=[this.x,this.y],this.initpos=[t,i],this.projectiles=[],this.traps=[],this.offs={headX:2,headY:-3,bodyX:0,bodyY:5},this},Player.prototype.complete=function(){var t=this.pieces;return t[0]+t[1]+t[2]+t[3]},Player.prototype.tick=function(t,i){var s=.9;this.projectiles=this.projectiles.filter(function(t){return t.tick(i)}),this.traps=this.traps.filter(function(t){return t.tick(i)}),t.isDown("up")&&(this.inWater||this.onLadder&&!this.onTopOfLadder?this.acc[1]-=s:this.falling||this.wasFalling||(audio.sfx.jump(),this.acc[1]=-i.sheet.h-1,this.vel[1]=0,this.falling=!0)),t.isDown("down")&&(t.isDown("fire")&&this.numTraps>0?this.trapLaunch<0?this.trapLaunch=20:-1===--this.trapLaunch&&(this.trapLaunch=1e3,this.numTraps--,this.traps.push((new Trap).init(this.x,this.y-2-24)),this.traps.forEach(function(t){t.setClosestPiece(this.level.pieces)},this)):(this.trapLaunch=-1,this.acc[1]+=s)),t.isDown("left")&&(this.acc[0]-=s,this.dir=-1),t.isDown("right")&&(this.acc[0]+=s,this.dir=1),t.pressed("fire")&&(this.projectiles.push((new Spear).init(this.x,this.y,this.dir)),audio.sfx.shoot()),this.tickVelocity(),this.wasFalling=this.falling,this.move(this.xo,this.yo,i),this.checkBlocks(t,i)},Player.prototype.tickVelocity=function(){this.grav=Math.min(this.falling?this.grav+.23:0,2.3),this.vel=[this.vel[0]+this.acc[0],this.vel[1]+this.acc[1]+this.grav],this.vel=[this.vel[0]*this.friction,this.vel[1]*this.friction],this.acc=[0,0],Math.abs(this.vel[0])<.01&&(this.vel[0]=0),Math.abs(this.vel[1])<.01&&(this.vel[1]=0),this.xo+=this.vel[0],this.yo+=this.vel[1]},Player.prototype.hit=function(t){if(t instanceof Pickup)return t.remove=!0,this.level.xp(t),audio.sfx.pickup(),this.numTraps++,0===this.numPickups++&&this.level.firstPickup(),void 0;if(t instanceof Ghoul)return this.killed(),void 0;if(t instanceof Piece){t.remove=!0;var i=this.pieces;return i[t.id]=!0,this.checkpoint=[this.x,this.y],this.level.xp(t),4===this.complete()?this.level.winsTheGame():(1===this.complete()&&this.level.firstPiece(),this.traps.forEach(function(i){i.setClosestPiece(this.level.pieces.filter(function(i){return i!==t}))},this)),void 0}},Player.prototype.hitSpear=function(t){t.stuck?(this.onLadder=!0,this.falling=!1,this.y+this.h-t.y<10&&(this.onTopOfLadder=!0,this.y=t.y-this.h)):this.onTopOfLadder=!1},Player.prototype.isMoving=function(){return Math.abs(this.vel[0])>.3||Math.abs(this.vel[1])>.3},Player.prototype.killed=function(){this.x=this.checkpoint[0],this.y=this.checkpoint[1]},Player.prototype.hitBlocks=function(t,i){(t&&t.indexOf(BLOCKS.type.LAVA)>-1||i&&i.indexOf(BLOCKS.type.LAVA)>-1)&&this.killed()},Player.prototype.checkBlocks=function(t,i){this.wasOnLadder=this.onLadder;var s=i.getBlocks([[this.x,this.y],[this.x,this.y+(this.h-1)],[this.x+(this.w-1),this.y],[this.x+(this.w-1),this.y+(this.h-1)]]);this.onTopOfLadder=!1,s.indexOf(BLOCKS.type.LADDER)>-1?(this.wasOnLadder||s[0]!==BLOCKS.type.LADDER&&s[2]!==BLOCKS.type.LADDER&&(this.y=utils.snap(this.y,i.sheet.h)+(i.sheet.h-this.h),this.onTopOfLadder=!0,t.isDown("down")||(this.vel[1]=0)),this.onLadder=!0,this.falling=!1):this.onLadder=!1,this.inWater=!1,s.indexOf(BLOCKS.type.WATER)>-1&&(this.yo+=4,this.inWater=!0,this.falling=!1),s.indexOf(BLOCKS.type.WATERRIGHT)>-1&&(this.xo+=4,this.inWater=!0),s.indexOf(BLOCKS.type.WATERLEFT)>-1&&(this.xo-=4,this.inWater=!0)},Player.prototype.render=function(t){t.shadowBlur=0,t.fillStyle="#900",t.fillRect(this.checkpoint[0],this.checkpoint[1]+this.h-4,this.w,4),this.projectiles.forEach(function(i){return i.render(t)}),this.traps.forEach(function(i){return i.render(t)}),t.strokeStyle="#000",t.lineWidth=2,t.fillStyle="hsl(10, 70%, 30%)",t.fillRect(this.x+this.offs.bodyX,this.y+this.offs.bodyY,12,15),t.strokeRect(this.x+this.offs.bodyX,this.y+this.offs.bodyY,12,15),t.fillStyle="hsl(20, 30%, 40%)",this.onLadder?(t.fillRect(this.x+3,this.y+this.offs.headY,6,10),t.strokeRect(this.x+3,this.y+this.offs.headY,6,10)):(t.fillRect(this.x+this.offs.headX*this.dir+3,this.y+this.offs.headY,6,10),t.strokeRect(this.x+this.offs.headX*this.dir+3,this.y+this.offs.headY,6,10)),t.fillStyle="hsl(55, 100%, 50%)",this.isMoving()?0===(0|Date.now()/100)%2?this.onLadder?(t.fillRect(this.x-2,this.y+2,3,5),t.fillRect(this.x+11,this.y+8,3,5),t.fillRect(this.x+2,this.y+20,3,2),t.fillRect(this.x+8,this.y+20,3,4)):(t.fillRect(this.x+2,this.y+20,3,3),t.fillRect(this.x+8,this.y+20,3,3),t.fillRect(this.x+4,this.y+11,3,5)):this.onLadder?(t.fillRect(this.x-2,this.y+8,3,5),t.fillRect(this.x+11,this.y+2,3,5),t.fillRect(this.x+2,this.y+20,3,4),t.fillRect(this.x+8,this.y+20,3,2)):(t.fillRect(this.x+4,this.y+20,4,3),t.fillRect(this.x+5,this.y+11,3,5)):!this.onLadder||this.wasFalling?(t.fillRect(this.x+2,this.y+20,3,3),t.fillRect(this.x+8,this.y+20,3,3),t.fillRect(this.x+4,this.y+11,3,5)):(t.fillRect(this.x-2,this.y+8,3,5),t.fillRect(this.x+11,this.y+2,3,5),t.fillRect(this.x+2,this.y+20,3,4),t.fillRect(this.x+8,this.y+20,3,2))};var Spear=function(){this.w=15,this.h=4,this.speed=8,this.dir=-1,this.life=200,this.remove=!1,this.stuck=!1,this.x=0,this.y=0};Spear.prototype=new Entity,Spear.prototype.init=function(t,i,s){return this.x=t,this.y=i,this.dir=s,this},Spear.prototype.tick=function(t){if(!this.stuck){var i=this.speed*this.dir,s=this.move(i,this.yo,t);0===s[0]&&(this.stuck=!0)}return this.life--<0&&(this.remove=!0),!this.remove},Spear.prototype.hit=function(t){t instanceof Spear?this.stuck=!0:this.remove=!0},Spear.prototype.render=function(t){t.fillStyle="hsl(55, 100%, 50%)",t.strokeStyle="#000",t.lineWidth=1,t.fillRect(this.x,this.y+1,this.w,this.h-2),t.fillRect(this.x+(this.dir<0?10:this.w-12),this.y,2,this.h),t.strokeRect(this.x-1,this.y,this.w+2,this.h)};var Pickup=function(){this.w=20,this.h=24,this.xpValue=3};Pickup.prototype=new Entity,Pickup.prototype.init=function(t,i){return this.x=t,this.y=i,this},Pickup.prototype.tick=function(){return!this.remove},Pickup.prototype.hit=function(){},Pickup.prototype.render=function(t){t.strokeStyle="#000",t.fillStyle="#a00",t.beginPath(),t.arc(this.x+this.w/2,this.y+this.h/2,this.w/3,0,2*Math.PI,!1),t.fill(),t.stroke()};var Piece=function(){this.w=20,this.h=24,this.xpValue=11};Piece.prototype=new Entity,Piece.prototype.init=function(t,i,s){return this.x=t,this.y=i,this.id=s,this},Piece.prototype.tick=function(){return!this.remove},Piece.prototype.hit=function(){},Piece.prototype.render=function(t){t.shadowColor="hsl(70, 100%, 50%)",t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=10,t.strokeStyle="#ff0",t.fillStyle="#aa0",t.beginPath(),t.arc(this.x+this.w/2,this.y+this.h/2,this.w/3,0,2*Math.PI,!1),t.fill(),t.stroke()};var Camera={x:0,y:0,xRange:80,yRange:100,init:function(t,i,s,e,h){return this.entity=t,this.w=e,this.h=h,this.x=i,this.y=s,this.track(t),this},setBounds:function(t,i){this.bounds=[t,i]},track:function(t){var i=t||this.entity;this.x=i.x-this.w/2+i.w/2,this.y=i.y-this.h/2,this.constrainToBounds()},constrainToBounds:function(){this.x<0&&(this.x=0),this.x>0&&this.bounds&&this.x+this.w>this.bounds[0]&&(this.x=this.bounds[0]-this.w),this.y<0&&(this.y=0),this.y>0&&this.bounds&&this.y+this.h>this.bounds[1]&&(this.y=this.bounds[1]-this.h)},tick:function(){var t=this.entity,i={x:this.x+this.w/2,y:this.y+this.h/2},s=this.xRange,e=this.yRange;t.x<i.x-s&&(this.x=t.x-this.w/2+s),t.x+t.w>i.x+s&&(this.x=t.x+t.w-this.w/2-s),t.y<i.y-e&&(this.y=t.y-this.h/2+e),t.y+t.h>i.y+e&&(this.y=t.y+t.h-this.h/2-e),this.constrainToBounds()},render:function(t,i){var s=this;t.save(),t.translate(-Math.round(this.x),-Math.round(this.y)),i.reduce(function(t,i){return Array.isArray(i)?t.concat(i):(t.push(i),t)},[]).filter(function(t){return t.repeat||!(t.x+t.w<s.x||t.y+t.h<s.y||t.x>s.x+s.w/s.zoom||t.y>s.y+s.h/s.zoom)}).forEach(function(i){i.render(t,s)}),t.restore()}},Dialog=function(){this.count=0};Dialog.prototype={init:function(t,i){return this.renderfunc=t,this.donefunc=i,this},tick:function(){return this.count++,this.count>50&&Input.isDown("fire")?(this.donefunc&&this.donefunc.call(this),!1):!0},render:function(t){t.fillStyle="rgba(0, 0, 0, 0.85)",t.fillRect(0,0,game.ctx.w,game.ctx.h),this.renderfunc.call(this,t)}},window.Screen=window.Screen||{},Screen.title={init:function(){return this},tick:function(){},render:function(t){t.fillStyle="#000",t.fillRect(0,0,t.w,t.h),t.fillStyle="#888",t.font="10pt monospace",t.fillText("abcdefghijklmnopqrstuvwxyz",.5*t.w,.5*t.h)}},window.Screen=window.Screen||{},Screen.level={init:function(){var t=makeSheet(game.res.tiles,game.tw,game.th);return this.player=(new Player).init(100,100,this),this.camera=Camera.init(this.player,0,0,game.ctx.w,game.ctx.h),this.map=Map.init(t,this.camera),this.pickups=this.map.pickups.map(function(t){return(new Pickup).init(t[0]*game.tw,t[1]*game.th)}),this.pieces=this.map.pieces.map(function(t,i){return(new Piece).init(t[0]*game.tw,t[1]*game.th,i)}),this.ghouls=[],this},tick:function(t){if(this.camera.tick(),this.player.tick(t,this.map),this.ghouls=this.ghouls.filter(function(t){return t.tick(this.map)},this),this.pickups=this.pickups.filter(function(t){return t.tick()}),this.pieces=this.pieces.filter(function(t){return t.tick()}),Math.random()<.01&&this.ghouls.length<35){for(var i,s,e=!1;!e;){i=0|Math.random()*(this.map.cellW-4),s=(0|Math.random()*(this.map.cellH-4))+2,e=!0;for(var h=0;4>h;h++)if(this.map.cells[s][i+h]>this.map.walkable||this.map.cells[s-1][i+h]>this.map.walkable||this.map.cells[s+1][i+h]>this.map.walkable){e=!1;break}}this.ghouls.push((new Ghoul).init((i+1)*game.tw,s*game.th,Math.random()<.5?1:-1,this)),Math.random()<.4*((this.player.complete()+1)/4)&&(this.ghouls[this.ghouls.length-1].isAngry=!0)}utils.checkCollisions([this.ghouls,this.player.projectiles]),utils.checkCollisions([this.ghouls,this.player.traps]),utils.checkCollision(this.player,this.player.projectiles,"hitSpear"),utils.checkCollision(this.player,this.pieces),utils.checkCollision(this.player,this.pickups),utils.checkCollision(this.player,this.ghouls)},xp:function(t){this.player.xp+=t.xpValue},firstPickup:function(){game.dialog=(new Dialog).init(function(t){game.res.font(t,"YOU HAVE FOUND A GHOUL TRAP...",40,60),game.res.font(t,"TO ACTIVATE IT, HOLD DOWN AND FIRE.",40,100),game.res.font(t,"CATCH A GHOUL TO FIND YOUR WAY.",40,150)})},firstPiece:function(){game.dialog=(new Dialog).init(function(t){game.res.font(t,"YOU HAVE FOUND A PIECE OF THE HOLY GRAIL.",40,60),game.res.font(t,"FIND THE REMAINING THREE PIECES TO",40,120),game.res.font(t,"COMPLETE YOUR QUEST.",40,150),game.res.font(t,"YOU WILL NOW RETURN HERE, IF YOU DIE.",40,220)})},winsTheGame:function(){game.dialog=(new Dialog).init(function(t){game.res.font(t,"YOU HAVE DISCOVERED THE LAST PIECE.",40,60),game.res.font(t,"IT'S BEAUUTIFUL.",40,120),game.res.font(t,"YOUR QUEST IS COMPLETE.",40,150)},function(){game.reset()})},render:function(t){t.clearRect(0,0,t.w,t.h),this.camera.render(t,[this.map,this.pickups,this.pieces,this.ghouls,this.player]),game.res.font(t,"GRAIL: "+this.player.complete()+"/4",20,20),game.res.font(t,"XP: "+this.player.xp,20,40),game.res.font(t,"TRAPS: "+this.player.numTraps,20,60)}};var Input={keys:{37:{wasDown:!1,isDown:!1},38:{wasDown:!1,isDown:!1},39:{wasDown:!1,isDown:!1},40:{wasDown:!1,isDown:!1},32:{wasDown:!1,isDown:!1}},actions:{up:38,right:39,down:40,left:37,fire:32},init:function(){function t(t,s){i.keys[t]&&(i.keys[t].wasDown=i.keys[t].isDown,i.keys[t].isDown=s)}var i=this;return document.addEventListener("keydown",function(i){t(i.keyCode,!0)},!1),document.addEventListener("keyup",function(i){t(i.keyCode,!1)},!1),this},reset:function(){for(var t in this.keys)this.keys[t].isDown=!1,this.keys[t].wasDown=!1},tick:function(){var t;for(t in this.keys)this.keys[t].wasDown=this.keys[t].isDown},isDown:function(t){return this.keys[this.actions[t]].isDown},wasDown:function(t){return this.keys[this.actions[t]].wasDown},pressed:function(t){return this.isDown(t)&&!this.wasDown(t)}},game={tw:20,th:24,dialog:null,init:function(){this.ctx=this.addMainCanvas(),this.res={tiles:GEN.tiles(this.tw,this.th),font:GEN.font()},this.input=Input.init(),audio.init(),this.reset(),this.run()},setScreen:function(t){this.screen=t.init()},addMainCanvas:function(){var t=utils.createCanvas(720,405,"board");return document.body.appendChild(t.canvas),t},reset:function(){this.input.reset(),this.setScreen(Screen.level)},run:function(){this.dialog?this.dialog.tick(this.input)||(this.dialog=null):this.screen.tick(this.input),this.input.tick(),this.screen.render(this.ctx),this.dialog&&this.dialog.render(this.ctx),window.requestAnimationFrame(function(){game.run(Date.now())})}};