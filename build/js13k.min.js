function makeSheet(t,i,e){return{w:i,h:e,cellW:Math.ceil(t.width/i),cellH:Math.ceil(t.height/e),render:function(s,h,n,a,r){s.drawImage(t,h*i,n*e,i,e,a,r,i,e)}}}var utils={snap:function(t,i){return Math.floor(t/i)*i},checkCollision:function(t,i,e){var s,h,n,a,r=t,e=e||"hit",o=i.length;for(s=0;o>s;s++)h=i[s],n=r.x+(r.xbb||0),a=h.x+(h.xbb||0),r!==h&&n+r.w>=a&&n<=a+h.w&&r.y+r.h>=h.y&&r.y<=h.y+h.h&&(r[e]&&r[e](h),h[e]&&h[e](r))},checkCollisions:function(t,i){var e,s,h,n,i=i||"hit",a=t.reduce(function(t,i){return Array.isArray(i)?t.concat(i):(t.push(i),t)},[]),r=a.length;for(e=0;r-1>e;e++)for(h=a[e],s=e+1;r>s;s++)n=a[s],h!==n&&h.x+h.w>=n.x&&h.x<=n.x+n.w&&h.y+h.h>=n.y&&h.y<=n.y+n.h&&(h[i]&&h[i](n),n[i]&&n[i](h))}};window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame;var GEN={tiles:function(t,i){var e,s,h,n,a,r,o,c=20;for(o=document.createElement("canvas"),o.setAttribute("width",c*t),o.setAttribute("height",1*i),r=o.getContext("2d"),a=r.createImageData(o.width,o.height),e=0;c>e;e++)for(h=0;i>h;h++)for(s=0;t>s;s++){var l,u=4*s+4*h*o.width+4*e*t,f=16711935,d=255;switch(d=255-(0|96*Math.random()),e){case 5:case 11:case 12:if(f=7426359,(3&3*s*s+41*s>>2)+8>h?f=6990400:(3&3*s*s+41*s>>2)+9>h&&(d=2*d/3),11===e&&2>s&&2>h){var y=Math.sqrt((2-s)*(2-s)+(2-h)*(2-h));y>=1.8&&(f=-1);break}if(12===e&&s>17&&2>h){var y=Math.sqrt((17-s)*(17-s)+(2-h)*(2-h));y>=1.9&&(f=-1);break}break;case 7:f=7426359;break;case 6:f=8355711;break;case 1:f=Math.random()<.15?5298487:-1,(1==(s+16*(h>>2))%8||0==h%8)&&(f=14795897);break;case 2:case 3:case 4:f=4948931,l=h%12-4*(e-2),0>l&&(l+=12),Math.abs(0|5*Math.sin(s/2))===l&&(f=16777215);break;case 8:case 9:case 10:f=16685824,l=h%4-(e-8),0>l&&(l+=4),Math.abs(0|2*Math.sin(s/2))===l&&(f=14756096),d=Math.min(255,1.4*d)}if(-1==f)a.data[u+0]=0,a.data[u+1]=0,a.data[u+2]=0,a.data[u+3]=0;else{var p=(255&f>>16)*d/255<<16|(255&f>>8)*d/255<<8|(255&f)*d/255;a.data[u+0]=255&p>>16,a.data[u+1]=255&p>>8,a.data[u+2]=255&p,a.data[u+3]=255}}for(n=0;n<o.width*o.height;n++);return r.putImageData(a,0,0),o}};!function(){function t(){var t=e.createBuffer(1,.5*e.sampleRate,e.sampleRate),s=t.getChannelData(0);for(i=0;i<s.length;i++)s[i]=(2*Math.random()-1)/2;var h=e.createBufferSource();return h.buffer=t,h.loop=!0,h}var e=new(window.AudioContext||window.webkitAudioContext);window.audio={sfx:{jump:function(){var t=e.currentTime,i=e.createOscillator(),s=e.createBiquadFilter(),h=e.createGain();i.connect(s),s.connect(h),h.connect(audio.master),h.gain.value=.15,s.frequency.value=2e3,s.Q.value=10,i.type="square",i.frequency.value=0,i.frequency.setValueAtTime(300,t),i.frequency.linearRampToValueAtTime(600,t+.1),i.start(0),i.stop(t+.1)},shoot:function(){var i=e.currentTime,s=t(),h=e.createBiquadFilter();h.connect(audio.master),h.Q.value=20;var n=0|2e3*Math.random()+500;h.frequency.value=n,h.frequency.setValueAtTime(n,i),h.frequency.linearRampToValueAtTime(100,i+.02),s.connect(h),s.start(0),s.stop(i+.04)},pickup:function(){var t=e.currentTime,i=e.createOscillator(),s=e.createBiquadFilter(),h=e.createGain();i.connect(s),s.connect(h),h.connect(audio.master),h.gain.value=.15,s.frequency.value=3e3,s.Q.value=10,i.type="sine",i.frequency.value=0,i.frequency.setValueAtTime(600,t),i.frequency.linearRampToValueAtTime(2600,t+.12),i.start(0),i.stop(t+.12)}},init:function(){this.ctx=e,this.master=e.createGain(),this.master.gain.value=.5,this.master.connect(e.destination),this.createTune()},stop:function(){this.osc.stop(e.currentTime)},createTune:function(){return}}}();var BLOCKS={walkable:4,type:{LADDER:1,WATER:2,WATERRIGHT:3,WATERLEFT:4,LAVA:8}};window.BLOCKS=BLOCKS,function(){var t;window.Map={x:0,y:0,init:function(t,i){return this.sheet=t,this.camera=i,this.expandRoomMap(this.generateRooms()),this.addPieces(),this.walkable=BLOCKS.walkable,this.cellH=this.cells.length,this.cellW=this.cells[0].length,this.h=this.cellH*t.h,this.w=this.cellW*t.w,this.camera.setBounds(this.w,this.h),this},generateRooms:function(){for(var i=[],e=0;12>e;e++){i.push([]);for(var s=0;15>s;s++)i[e].push(0|Math.random()*t.length)}return i},expandRoomMap:function(i){var e=[],s=i.length,h=i[0].length,n=t[0][0].length,a=t[0].length;e=new Array(s*a);for(var r=0;r<e.length;r++){e[r]=new Array(h*n);for(var o=0;o<e[0].length;o++){var c=0|o/n,l=0|r/a,u=i[l][c];e[r][o]=t[u][r%a][o%n]}}this.cells=e},addPieces:function(){this.pieces=[];for(var t=0;30>t;t++)this.pieces.push([0|Math.random()*this.cells.length,0|Math.random()*this.cells[0].length])},tick:function(){},getBlocks:function(t){return t.map(function(t){var i=0|t[1]/this.sheet.h,e=0|t[0]/this.sheet.w;return 0>i||i>this.cellH-1?null:this.cells[i][e]},this)},getBlockEdge:function(t,i){var e=i?this.sheet.h:this.sheet.w;return utils.snap(t,e)},render:function(t){var i,e,s,h=game.tw,n=game.th,a=this.sheet.cellW,r=(this.sheet.cellH,0|this.camera.x/h),o=0|this.camera.y/n,c=r+(0|this.camera.w/h)+1,l=o+(0|this.camera.h/n)+1;for(i=o;l>=i;i++)if(!(0>i||i>this.cellH-1))for(e=r;c>=e;e++)e>this.cellW-1||(s=this.cells[i][e],0!==s&&(s>=2&&4>=s&&(s=(0|Date.now()/200%3)+2),s>=8&&10>=s&&(s=(0|Date.now()/400%3)+8),this.sheet.render(t,0|s%a,0|s/a,e*h,i*n)))}},t=[[[0,0,0,1,1,0,0,0,1,1,0],[0,0,0,1,1,1,1,1,1,1,0],[0,0,0,1,1,1,1,1,1,1,0],[0,0,0,1,0,0,0,0,0,1,0],[0,0,0,0,0,5,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0],[5,1,5,5,5,5,5,5,1,5,5]],[[0,0,0,0,0,0,0,0,0,0,0],[0,12,0,0,0,0,0,0,0,0,0],[5,8,12,0,0,0,0,0,6,1,6],[7,8,8,12,0,0,0,0,0,1,0],[7,8,8,8,12,0,0,0,0,1,0],[7,0,8,8,8,12,0,0,0,1,0],[0,0,5,5,5,5,5,5,5,1,5]],[[0,0,0,0,0,0,0,0,0,0,1],[0,0,0,0,0,0,0,0,0,0,1],[0,0,0,0,6,6,0,0,0,0,1],[0,0,0,0,0,6,6,6,0,0,0],[0,0,0,0,0,0,0,0,0,0,0],[5,5,5,5,5,5,5,5,5,5,0],[7,7,7,7,7,7,7,7,7,7,1]],[[0,0,0,0,0,0,2,0,0,0,7],[0,0,0,0,0,0,2,0,0,11,7],[6,1,1,0,0,0,3,3,3,2,7],[0,1,1,0,0,0,7,7,7,2,7],[0,1,1,0,0,11,7,7,7,2,7],[5,1,1,5,5,7,7,2,4,4,7],[7,7,1,7,7,7,2,2,7,7,7]],[[7,0,0,0,0,0,0,0,0,0,1],[7,0,0,0,0,0,0,0,0,0,7],[7,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0],[7,0,0,5,12,0,0,0,0,0,5],[1,0,5,7,7,0,0,0,0,0,7],[1,5,7,7,7,0,5,5,5,1,7]],[[0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,5,5],[0,0,0,0,0,0,0,0,5,7,0],[0,0,0,0,0,0,0,5,7,0,0],[0,0,0,0,0,0,0,0,0,0,5],[0,0,5,5,12,0,0,0,0,0,7],[7,5,7,7,7,0,5,5,5,1,7]],[[0,0,0,0,5,5,5,0,0,0,0],[5,0,0,0,0,0,0,0,0,5,5],[0,0,0,0,0,0,0,0,5,7,0],[0,0,5,5,0,0,0,5,7,0,0],[0,0,0,0,5,5,0,0,0,0,5],[0,0,0,0,0,0,0,0,0,0,7],[0,0,0,0,0,0,0,0,0,0,0]]]}();var Entity=function(){this.w=10,this.h=10,this.remove=!1,this.falling=!1,this.xo=0,this.yo=0};Entity.prototype={init:function(t,i){return this.x=t,this.y=i,this},hit:function(){},hitBlocks:function(){},tick:function(){return!this.remove},move:function(t,i,e){var s,h,n,a,r,o,c=!1,l=!1;return s=t,h=i,n=this.x+s,a=this.y+h,o=e.getBlocks([[this.x,a],[this.x,a+(this.h-1)],[this.x+(this.w-1),a],[this.x+(this.w-1),a+(this.h-1)]]),0>i&&(o[0]>e.walkable||o[2]>e.walkable)&&(h=e.getBlockEdge((0|a)+e.sheet.h,"VERT")-this.y,l=!0),i>0&&(o[1]>e.walkable||o[3]>e.walkable)&&(h=e.getBlockEdge(a+this.h,"VERT")-this.y-this.h,l=!0),this.y+=h,r=e.getBlocks([[n,this.y],[n,this.y+(this.h-1)],[n+(this.w-1),this.y],[n+(this.w-1),this.y+(this.h-1)]]),0>t&&(r[0]>e.walkable||r[1]>e.walkable)&&(s=e.getBlockEdge(n+e.sheet.w)-this.x,c=!0),t>0&&(r[2]>e.walkable||r[3]>e.walkable)&&(s=e.getBlockEdge(n+this.w)-this.x-this.w,c=!0),(c||l)&&this.hitBlocks(c?r:null,l?o:null),this.x+=s,o=e.getBlocks([[this.x,this.y+this.h],[this.x+(this.w-1),this.y+this.h]]),this.wasFalling=this.falling,this.falling=o[0]<=e.walkable&&o[1]<=e.walkable?this.onLadder?!1:!0:!1,this.xo=0,this.yo=0,[s,h]},render:function(t){t.fillStyle="red",t.fillRect(this.x,this.y,this.w,this.h)}};var Ghoul=function(){this.w=15,this.h=22,this.dir=1,this.speed=3};Ghoul.prototype=new Entity,Ghoul.prototype.init=function(t,i,e){return this.x=t,this.y=i,this.dir=e||1,this.offs={headX:2,headY:-3,bodyX:0,bodyY:5},this},Ghoul.prototype.hit=function(t){t instanceof Spear&&!t.stuck&&(this.remove=!0),t instanceof Trap&&(this.remove=!0)},Ghoul.prototype.tick=function(){return this.y+=Math.sin(Date.now()/100),this.x+=this.speed*this.dir,(this.x<0||this.x>game.ctx.w)&&(this.dir*=-1),!this.remove},Ghoul.prototype.render=function(t){t.strokeStyle="hsl(70, 100%, 50%)",t.shadowColor="hsl(70, 100%, 50%)",t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=10,t.fillStyle="hsl(180, 80%, 50%)",t.fillRect(this.x+this.offs.bodyX,this.y+this.offs.bodyY,12,15),t.fillStyle="hsl(120, 30%, 40%)",t.fillRect(this.x+this.offs.headX*this.dir+3,this.y+this.offs.headY,6,10),t.fillStyle="hsl(120, 40%, 50%)",t.fillRect(this.x+2,this.y+20,8,3),t.fillRect(this.x+4,this.y+11,3,5)};var Player=function(){this.w=12,this.h=23,this.vel=[0,0],this.acc=[0,0],this.grav=0,this.friction=.75,this.falling=!0,this.wasFalling=!1,this.onLadder=!1,this.wasOnLadder=!1,this.dir=1,this.trapLaunch=-1};Player.prototype=new Entity,Player.prototype.init=function(t,i){return this.x=t,this.y=i,this.initpos=[t,i],this.projectiles=[],this.traps=[],this.offs={headX:2,headY:-3,bodyX:0,bodyY:5},this},Player.prototype.tick=function(t,i){var e=.9;this.projectiles=this.projectiles.filter(function(t){return t.tick(i)}),this.traps=this.traps.filter(function(t){return t.tick(i)}),t.isDown("up")&&(this.inWater||this.onLadder&&!this.onTopOfLadder?this.acc[1]-=e:this.falling||this.wasFalling||(audio.sfx.jump(),this.acc[1]=-i.sheet.h-1,this.vel[1]=0,this.falling=!0)),t.isDown("down")&&(t.isDown("fire")?this.trapLaunch<0?this.trapLaunch=20:-1===--this.trapLaunch&&(this.trapLaunch=1e3,this.traps.push((new Trap).init(this.x,this.y-2-24))):(this.trapLaunch=-1,this.acc[1]+=e)),t.isDown("left")&&(this.acc[0]-=e,this.dir=-1),t.isDown("right")&&(this.acc[0]+=e,this.dir=1),t.pressed("fire")&&(this.projectiles.push((new Spear).init(this.x,this.y,this.dir)),audio.sfx.shoot()),this.tickVelocity(),this.wasFalling=this.falling,this.move(this.xo,this.yo,i),this.checkBlocks(t,i)},Player.prototype.tickVelocity=function(){this.grav=this.falling?this.grav+.25:0,this.vel=[this.vel[0]+this.acc[0],this.vel[1]+this.acc[1]+this.grav],this.vel=[this.vel[0]*this.friction,this.vel[1]*this.friction],this.acc=[0,0],Math.abs(this.vel[0])<.01&&(this.vel[0]=0),Math.abs(this.vel[1])<.01&&(this.vel[1]=0),this.xo+=this.vel[0],this.yo+=this.vel[1]},Player.prototype.hit=function(t){t instanceof Piece&&(t.remove=!0,audio.sfx.pickup())},Player.prototype.hitSpear=function(t){t.stuck?(this.onLadder=!0,this.falling=!1,this.y+this.h-t.y<10&&(this.onTopOfLadder=!0,this.y=t.y-this.h)):this.onTopOfLadder=!1},Player.prototype.isMoving=function(){return Math.abs(this.vel[0])>.3||Math.abs(this.vel[1])>.3},Player.prototype.hitBlocks=function(t,i){(t&&t.indexOf(BLOCKS.type.LAVA)>-1||i&&i.indexOf(BLOCKS.type.LAVA)>-1)&&(this.x=this.initpos[0],this.y=this.initpos[1])},Player.prototype.checkBlocks=function(t,i){this.wasOnLadder=this.onLadder;var e=i.getBlocks([[this.x,this.y],[this.x,this.y+(this.h-1)],[this.x+(this.w-1),this.y],[this.x+(this.w-1),this.y+(this.h-1)]]);this.onTopOfLadder=!1,e.indexOf(BLOCKS.type.LADDER)>-1?(this.wasOnLadder||e[0]!==BLOCKS.type.LADDER&&e[2]!==BLOCKS.type.LADDER&&(this.y=utils.snap(this.y,i.sheet.h)+(i.sheet.h-this.h),this.onTopOfLadder=!0,t.isDown("down")||(this.vel[1]=0)),this.onLadder=!0,this.falling=!1):this.onLadder=!1,this.inWater=!1,e.indexOf(BLOCKS.type.WATER)>-1&&(this.yo+=4,this.inWater=!0,this.falling=!1),e.indexOf(BLOCKS.type.WATERRIGHT)>-1&&(this.xo+=4,this.inWater=!0),e.indexOf(BLOCKS.type.WATERLEFT)>-1&&(this.xo-=4,this.inWater=!0)},Player.prototype.render=function(t){t.shadowBlur=0,this.projectiles.forEach(function(i){return i.render(t)}),this.traps.forEach(function(i){return i.render(t)}),t.strokeStyle="#000",t.fillStyle="hsl(10, 70%, 30%)",t.fillRect(this.x+this.offs.bodyX,this.y+this.offs.bodyY,12,15),t.strokeRect(this.x+this.offs.bodyX,this.y+this.offs.bodyY,12,15),t.fillStyle="hsl(20, 30%, 40%)",this.onLadder?(t.fillRect(this.x+3,this.y+this.offs.headY,6,10),t.strokeRect(this.x+3,this.y+this.offs.headY,6,10)):(t.fillRect(this.x+this.offs.headX*this.dir+3,this.y+this.offs.headY,6,10),t.strokeRect(this.x+this.offs.headX*this.dir+3,this.y+this.offs.headY,6,10)),t.fillStyle="hsl(55, 100%, 50%)",this.isMoving()?0===(0|Date.now()/100)%2?this.onLadder?(t.fillRect(this.x-2,this.y+2,3,5),t.fillRect(this.x+11,this.y+8,3,5),t.fillRect(this.x+2,this.y+20,3,2),t.fillRect(this.x+8,this.y+20,3,4)):(t.fillRect(this.x+2,this.y+20,3,3),t.fillRect(this.x+8,this.y+20,3,3),t.fillRect(this.x+4,this.y+11,3,5)):this.onLadder?(t.fillRect(this.x-2,this.y+8,3,5),t.fillRect(this.x+11,this.y+2,3,5),t.fillRect(this.x+2,this.y+20,3,4),t.fillRect(this.x+8,this.y+20,3,2)):(t.fillRect(this.x+4,this.y+20,4,3),t.fillRect(this.x+5,this.y+11,3,5)):!this.onLadder||this.wasFalling?(t.fillRect(this.x+2,this.y+20,3,3),t.fillRect(this.x+8,this.y+20,3,3),t.fillRect(this.x+4,this.y+11,3,5)):(t.fillRect(this.x-2,this.y+8,3,5),t.fillRect(this.x+11,this.y+2,3,5),t.fillRect(this.x+2,this.y+20,3,4),t.fillRect(this.x+8,this.y+20,3,2))};var Spear=function(){this.w=15,this.h=4,this.speed=8,this.dir=-1,this.life=200,this.remove=!1,this.stuck=!1,this.x=0,this.y=0};Spear.prototype=new Entity,Spear.prototype.init=function(t,i,e){return this.x=t,this.y=i,this.dir=e,this},Spear.prototype.tick=function(t){if(!this.stuck){var i=this.speed*this.dir,e=this.move(i,this.yo,t);0===e[0]&&(this.stuck=!0)}return this.life--<0&&(this.remove=!0),!this.remove},Spear.prototype.hit=function(t){t instanceof Spear?this.stuck=!0:this.remove=!0},Spear.prototype.render=function(t){t.fillStyle="hsl(55, 100%, 50%)",t.strokeStyle="#000",t.lineWidth=1,t.fillRect(this.x,this.y+1,this.w,this.h-2),t.fillRect(this.x+(this.dir<0?10:this.w-12),this.y,2,this.h),t.strokeRect(this.x-1,this.y,this.w+2,this.h)};var Piece=function(){this.w=20,this.h=24};Piece.prototype=new Entity,Piece.prototype.init=function(t,i){return this.x=t,this.y=i,this},Piece.prototype.tick=function(){return!this.remove},Piece.prototype.hit=function(){},Piece.prototype.render=function(t){t.strokeStyle="#000",t.fillStyle="#a00",t.beginPath(),t.arc(this.x+this.w/2,this.y+this.h/2,this.w/3,0,2*Math.PI,!1),t.fill(),t.stroke()};var Camera={x:0,y:0,xRange:80,yRange:100,init:function(t,i,e,s,h){return this.entity=t,this.w=s,this.h=h,this.x=i,this.y=e,this.track(t),this},setBounds:function(t,i){this.bounds=[t,i]},track:function(t){var i=t||this.entity;this.x=i.x-this.w/2+i.w/2,this.y=i.y-this.h/2,this.constrainToBounds()},constrainToBounds:function(){this.x<0&&(this.x=0),this.x>0&&this.bounds&&this.x+this.w>this.bounds[0]&&(this.x=this.bounds[0]-this.w),this.y<0&&(this.y=0),this.y>0&&this.bounds&&this.y+this.h>this.bounds[1]&&(this.y=this.bounds[1]-this.h)},tick:function(){var t=this.entity,i={x:this.x+this.w/2,y:this.y+this.h/2},e=this.xRange,s=this.yRange;t.x<i.x-e&&(this.x=t.x-this.w/2+e),t.x+t.w>i.x+e&&(this.x=t.x+t.w-this.w/2-e),t.y<i.y-s&&(this.y=t.y-this.h/2+s),t.y+t.h>i.y+s&&(this.y=t.y+t.h-this.h/2-s),this.constrainToBounds()},render:function(t,i){var e=this;t.save(),t.translate(-Math.round(this.x),-Math.round(this.y)),i.reduce(function(t,i){return Array.isArray(i)?t.concat(i):(t.push(i),t)},[]).filter(function(t){return t.repeat||!(t.x+t.w<e.x||t.y+t.h<e.y||t.x>e.x+e.w/e.zoom||t.y>e.y+e.h/e.zoom)}).forEach(function(i){i.render(t,e)}),t.restore()}};window.Screen=window.Screen||{},Screen.title={init:function(){return this},tick:function(){},render:function(t){t.fillStyle="#000",t.fillRect(0,0,t.w,t.h),t.fillStyle="#888",t.font="10pt monospace",t.fillText("abcdefghijklmnopqrstuvwxyz",.5*t.w,.5*t.h)}},window.Screen=window.Screen||{},Screen.level={init:function(){var t=makeSheet(game.res.tiles,game.tw,game.th);return this.player=(new Player).init(100,100),this.camera=Camera.init(this.player,0,0,game.ctx.w,game.ctx.h),this.map=Map.init(t,this.camera),this.pieces=this.map.pieces.map(function(t){return(new Piece).init(t[0]*game.tw,t[1]*game.th)}),this.ghouls=[(new Ghoul).init(200,285)],this},tick:function(t){this.camera.tick(),this.player.tick(t,this.map),this.ghouls=this.ghouls.filter(function(t){return t.tick()}),this.pieces=this.pieces.filter(function(t){return t.tick()}),Math.random()<.01&&this.ghouls.length<15&&this.ghouls.push((new Ghoul).init(5,[110,280,420][0|3*Math.random()],1)),utils.checkCollisions([this.ghouls,this.player.projectiles]),utils.checkCollisions([this.ghouls,this.player.traps]),utils.checkCollision(this.player,this.player.projectiles,"hitSpear"),utils.checkCollision(this.player,this.pieces)},render:function(t){t.clearRect(0,0,t.w,t.h),t.fillStyle="#550",t.font="10pt monospace",t.fillText("abcdefghijklmnopqrstuvwxyz",.5*t.w,.5*t.h),this.camera.render(t,[this.map,this.pieces,this.ghouls,this.player])}};var Input={keys:{37:{wasDown:!1,isDown:!1},38:{wasDown:!1,isDown:!1},39:{wasDown:!1,isDown:!1},40:{wasDown:!1,isDown:!1},32:{wasDown:!1,isDown:!1}},actions:{up:38,right:39,down:40,left:37,fire:32},init:function(){function t(t,e){i.keys[t]&&(i.keys[t].wasDown=i.keys[t].isDown,i.keys[t].isDown=e)}var i=this;return document.addEventListener("keydown",function(i){t(i.keyCode,!0)},!1),document.addEventListener("keyup",function(i){t(i.keyCode,!1)},!1),this},tick:function(){var t;for(t in this.keys)this.keys[t].wasDown=this.keys[t].isDown},isDown:function(t){return this.keys[this.actions[t]].isDown},wasDown:function(t){return this.keys[this.actions[t]].wasDown},pressed:function(t){return this.isDown(t)&&!this.wasDown(t)}},game={tw:20,th:24,res:{},init:function(){this.ctx=this.addMainCanvas(),this.font=this.createChars(),this.res={tiles:GEN.tiles(this.tw,this.th)},audio.init(),this.input=Input.init(),this.reset(),this.run()},setScreen:function(t){this.screen=t.init()},createCanvas:function(t,i,e){var s=document.createElement("canvas"),h=s.getContext("2d");return h.imageSmoothingEnabled=!1,h.mozImageSmoothingEnabled=!1,h.webkitImageSmoothingEnabled=!1,h.w=t,h.h=i,s.setAttribute("height",i),s.setAttribute("width",t),e&&s.setAttribute("id",e),h},addMainCanvas:function(){var t=this.createCanvas(720,405,"board");return document.body.appendChild(t.canvas),t},createChars:function(){var t=this.createCanvas(360,12),i=this.createCanvas(720,24),e="ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890!?.:;'",s=e.split("");t.fillStyle="#fff",t.font="12px courier new",s.forEach(function(i,e){t.fillText(i,8*e,8)}),document.body.appendChild(t.canvas);for(var h=t.getImageData(0,0,t.canvas.width,t.canvas.height),n=i.getImageData(0,0,i.canvas.width,i.canvas.height),a=2,r=0;r<h.height;r++)for(var o=0;o<h.width;o++){var c=[h.data[4*(r*h.width+o)+0],h.data[4*(r*h.width+o)+1],h.data[4*(r*h.width+o)+2],h.data[4*(r*h.width+o)+3]];c[3]<36?c[3]>0?(c[0]=255,c[1]=255,c[2]=0,c[3]=155):c[3]=0:c[3]=255;for(var l=0;a>l;l++)for(var u=r*a+l,f=0;a>f;f++)for(var d=o*a+f,y=0;4>y;y++)n.data[4*(u*n.width+d)+y]=c[y]}i.putImageData(n,0,0),document.body.appendChild(i.canvas);var p=makeSheet(i.canvas,16,24);return function(t,i,e,h){i.split("").forEach(function(i,n){return" "!==i&&p.render(t,s.indexOf(i),0,e+16*n,h),!0})}},reset:function(){this.setScreen(Screen.level)},run:function(){this.screen.tick(this.input),this.input.tick(),this.screen.render(this.ctx),this.font(this.ctx,"HEY CHAPS! YOU ROK",14,20),window.requestAnimationFrame(function(){game.run(Date.now())})}};