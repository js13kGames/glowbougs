function makeSheet(t,i,s){return{w:i,h:s,cellW:Math.ceil(t.width/i),cellH:Math.ceil(t.height/s),render:function(e,h,n,a,r){e.drawImage(t,h*i,n*s,i,s,a,r,i,s)}}}var utils={snap:function(t,i){return Math.floor(t/i)*i},checkCollision:function(t,i,s){var e,h,n,a,r=t,s=s||"hit",o=i.length;for(e=0;o>e;e++)h=i[e],n=r.x+(r.xbb||0),a=h.x+(h.xbb||0),r!==h&&n+r.w>=a&&n<=a+h.w&&r.y+r.h>=h.y&&r.y<=h.y+h.h&&(r[s]&&r[s](h),h[s]&&h[s](r))},checkCollisions:function(t,i){var s,e,h,n,i=i||"hit",a=t.reduce(function(t,i){return Array.isArray(i)?t.concat(i):(t.push(i),t)},[]),r=a.length;for(s=0;r-1>s;s++)for(h=a[s],e=s+1;r>e;e++)n=a[e],h!==n&&h.x+h.w>=n.x&&h.x<=n.x+n.w&&h.y+h.h>=n.y&&h.y<=n.y+n.h&&(h[i]&&h[i](n),n[i]&&n[i](h))}};window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame;var GEN={tiles:function(t,i){var s,e,h,n,a,r,o,c=20;for(o=document.createElement("canvas"),o.setAttribute("width",c*t),o.setAttribute("height",1*i),r=o.getContext("2d"),a=r.createImageData(o.width,o.height),s=0;c>s;s++)for(h=0;i>h;h++)for(e=0;t>e;e++){var l,u=4*e+4*h*o.width+4*s*t,f=16711935,y=255;switch(y=255-(0|96*Math.random()),s){case 5:case 11:case 12:if(f=7426359,(3&3*e*e+41*e>>2)+8>h?f=6990400:(3&3*e*e+41*e>>2)+9>h&&(y=2*y/3),11===s&&2>e&&2>h){var d=Math.sqrt((2-e)*(2-e)+(2-h)*(2-h));d>=1.8&&(f=-1);break}if(12===s&&e>17&&2>h){var d=Math.sqrt((17-e)*(17-e)+(2-h)*(2-h));d>=1.9&&(f=-1);break}break;case 7:f=7426359;break;case 6:f=8355711;break;case 1:f=Math.random()<.15?5298487:-1,(1==(e+16*(h>>2))%8||0==h%8)&&(f=14795897);break;case 2:case 3:case 4:f=4948931,l=h%12-4*(s-2),0>l&&(l+=12),Math.abs(0|5*Math.sin(e/2))===l&&(f=16777215);break;case 8:case 9:case 10:f=16685824,l=h%4-(s-8),0>l&&(l+=4),Math.abs(0|2*Math.sin(e/2))===l&&(f=14756096),y=Math.min(255,1.4*y)}if(-1==f)a.data[u+0]=0,a.data[u+1]=0,a.data[u+2]=0,a.data[u+3]=0;else{var w=(255&f>>16)*y/255<<16|(255&f>>8)*y/255<<8|(255&f)*y/255;a.data[u+0]=255&w>>16,a.data[u+1]=255&w>>8,a.data[u+2]=255&w,a.data[u+3]=255}}for(n=0;n<o.width*o.height;n++);return r.putImageData(a,0,0),o}};!function(){function t(){var t=s.createBuffer(1,.5*s.sampleRate,s.sampleRate),e=t.getChannelData(0);for(i=0;i<e.length;i++)e[i]=(2*Math.random()-1)/2;var h=s.createBufferSource();return h.buffer=t,h.loop=!0,h}var s=new(window.AudioContext||window.webkitAudioContext);window.audio={sfx:{jump:function(){var t=s.currentTime,i=s.createOscillator(),e=s.createBiquadFilter(),h=s.createGain();i.connect(e),e.connect(h),h.connect(audio.master),h.gain.value=.15,e.frequency.value=2e3,e.Q.value=10,i.type="square",i.frequency.value=0,i.frequency.setValueAtTime(300,t),i.frequency.linearRampToValueAtTime(600,t+.1),i.start(0),i.stop(t+.1)},shoot:function(){var i=s.currentTime,e=t(),h=s.createBiquadFilter();h.connect(audio.master),h.Q.value=20;var n=0|2e3*Math.random()+500;h.frequency.value=n,h.frequency.setValueAtTime(n,i),h.frequency.linearRampToValueAtTime(100,i+.02),e.connect(h),e.start(0),e.stop(i+.04)}},init:function(){this.ctx=s,this.master=s.createGain(),this.master.gain.value=.5,this.master.connect(s.destination),this.createTune()},stop:function(){this.osc.stop(s.currentTime)},createTune:function(){return}}}();var BLOCKS={walkable:4,type:{LADDER:1,WATER:2,WATERRIGHT:3,WATERLEFT:4,LAVA:8}};window.BLOCKS=BLOCKS;var Map={x:0,y:0,init:function(t,i){return this.sheet=t,this.camera=i,this.cells=[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,7,7],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,7,7],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,7,7],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,11,1,5,12,0,0,0,0,0,0,0,0,0,0,0,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,11,1,5,12,0,0,0,0,0,0,0,0,0,0,0,7,7],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,11,7,1,7,7,12,0,0,0,0,0,0,0,0,0,0,0,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,11,7,1,7,7,12,0,0,0,0,0,0,0,0,0,0,0,7],[12,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,7,7,1,7,7,7,0,0,0,0,0,0,0,0,0,0,0,7,12,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,7,7,1,7,7,7,0,0,0,0,0,0,0,0,0,0,0,7],[7,0,0,11,5,5,5,12,0,11,5,5,5,5,5,5,5,5,5,5,7,7,1,7,7,7,5,5,5,5,5,12,2,11,5,5,5,7,7,0,0,11,5,5,5,12,0,11,5,5,5,5,5,5,5,5,5,5,7,7,1,7,7,7,5,5,5,5,5,12,2,11,5,5,5,7],[7,0,0,7,7,7,7,7,0,7,7,7,7,7,7,7,7,7,7,7,7,7,1,7,7,7,7,7,7,7,7,7,2,7,7,7,7,7,7,0,0,7,7,7,7,7,0,7,7,7,7,7,7,7,7,7,7,7,7,7,1,7,7,7,7,7,7,7,7,7,2,7,7,7,7,7],[8,12,0,0,0,6,0,6,0,6,0,6,0,6,0,6,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,2,0,0,0,7,7,8,12,0,0,0,6,0,6,0,6,0,6,0,6,0,6,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,2,0,0,0,7,7],[5,8,12,0,0,0,0,0,0,0,0,0,0,0,0,0,6,6,0,0,0,0,1,0,0,0,0,0,0,0,0,0,2,0,0,11,7,7,5,8,12,0,0,0,0,0,0,0,0,0,0,0,0,0,6,6,0,0,0,0,1,0,0,0,0,0,0,0,0,0,2,0,0,11,7,7],[7,8,8,12,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,6,6,1,0,0,0,0,0,0,3,3,3,2,7,7,7,8,8,12,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,6,6,1,0,0,0,0,0,0,3,3,3,2,7,7],[7,8,8,8,12,0,0,0,0,0,0,0,0,0,0,0,0,6,6,6,0,0,0,0,0,1,0,0,0,0,0,0,7,7,7,2,7,7,7,8,8,8,12,0,0,0,0,0,0,0,0,0,0,0,0,6,6,6,0,0,0,0,0,1,0,0,0,0,0,0,7,7,7,2,7,7],[7,0,8,8,8,12,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,11,7,7,7,2,7,7,7,0,8,8,8,12,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,11,7,7,7,2,7,7],[7,0,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,0,5,5,1,5,5,5,5,5,7,7,2,4,4,7,7,7,0,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,0,5,5,1,5,5,5,5,5,7,7,2,4,4,7,7],[7,0,0,6,0,6,0,6,0,6,0,6,0,6,0,0,0,0,0,0,0,6,0,0,0,1,0,0,0,0,0,0,2,4,0,0,7,7,7,0,0,6,0,6,0,6,0,6,0,6,0,6,0,0,0,0,0,0,0,6,0,0,0,1,0,0,0,0,0,0,2,4,0,0,7,7],[7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,0,0,0,0,2,0,0,0,0,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,0,0,0,0,2,0,0,0,0,7],[7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,6,6,6,0,0,6,0,0,0,0,0,0,0,0,2,0,0,0,0,0,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,6,6,6,0,0,6,0,0,0,0,0,0,0,0,2,0,0,0,0,0],[7,0,0,0,0,0,0,0,0,0,0,0,0,0,6,6,6,6,0,0,0,0,0,0,6,0,0,0,0,0,0,0,2,0,0,0,0,8,7,0,0,0,0,0,0,0,0,0,0,0,0,0,6,6,6,6,0,0,0,0,0,0,6,0,0,0,0,0,0,0,2,0,0,0,0,8],[7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,4,4,0,0,8,8,5,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,4,4,0,0,8,8,5],[7,5,5,5,5,5,5,0,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,1,5,5,5,5,2,5,5,5,5,5,5,7,7,5,5,5,5,5,5,0,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,1,5,5,5,5,2,5,5,5,5,5,5,7],[7,7,7,7,7,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,4,4,7,7,7,7,7,7,7,7,7,7,7,7,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,4,4,7,7,7,7,7,7,7],[7,7,7,7,7,7,7,5,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,5,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,7,7,7,7,7,7,7,7,7],[7,7,7,7,7,7,7,7,7,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,7,7,7,7,7,7,7,7,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,7,7,7,7,7,7,7,7,7],[7,7,7,7,7,7,7,7,7,7,5,5,5,5,5,5,5,5,5,5,5,5,5,0,5,5,5,5,5,7,7,7,7,7,7,7,7,7,7,1,7,7,7,7,7,7,7,7,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,7,7,7,7,7,7,7,7,7],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,7,7,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,7,7],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,7,7],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,7,7],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,11,1,5,12,0,0,0,0,0,0,0,0,0,0,0,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,11,1,5,12,0,0,0,0,0,0,0,0,0,0,0,7,7],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,11,7,1,7,7,12,0,0,0,0,0,0,0,0,0,0,0,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,11,7,1,7,7,12,0,0,0,0,0,0,0,0,0,0,0,7],[12,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,7,7,1,7,7,7,0,0,0,0,0,0,0,0,0,0,0,7,12,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,7,7,1,7,7,7,0,0,0,0,0,0,0,0,0,0,0,7],[7,0,0,11,5,5,5,12,0,11,5,5,5,5,5,5,5,5,5,5,7,7,1,7,7,7,5,5,5,5,5,12,2,11,5,5,5,7,7,0,0,11,5,5,5,12,0,11,5,5,5,5,5,5,5,5,5,5,7,7,1,7,7,7,5,5,5,5,5,12,2,11,5,5,5,7],[7,0,0,7,7,7,7,7,0,7,7,7,7,7,7,7,7,7,7,7,7,7,1,7,7,7,7,7,7,7,7,7,2,7,7,7,7,7,7,0,0,7,7,7,7,7,0,7,7,7,7,7,7,7,7,7,7,7,7,7,1,7,7,7,7,7,7,7,7,7,2,7,7,7,7,7],[8,12,0,0,0,6,0,6,0,6,0,6,0,6,0,6,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,2,0,0,0,7,7,8,12,0,0,0,6,0,6,0,6,0,6,0,6,0,6,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,2,0,0,0,7,7],[5,8,12,0,0,0,0,0,0,0,0,0,0,0,0,0,6,6,0,0,0,0,1,0,0,0,0,0,0,0,0,0,2,0,0,11,7,7,5,8,12,0,0,0,0,0,0,0,0,0,0,0,0,0,6,6,0,0,0,0,1,0,0,0,0,0,0,0,0,0,2,0,0,11,7,7],[7,8,8,12,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,6,6,1,0,0,0,0,0,0,3,3,3,2,7,7,7,0,0,12,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,6,6,1,0,0,0,0,0,0,3,3,3,2,7,7],[7,8,8,8,12,0,0,0,0,0,0,0,0,0,0,0,0,6,6,6,0,0,0,0,0,1,0,0,0,0,0,0,7,7,7,2,7,7,7,0,0,0,12,0,0,0,0,0,0,0,0,0,0,0,0,6,6,6,0,0,0,0,0,1,0,0,0,0,0,0,7,7,7,2,7,7],[7,0,8,8,8,12,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,11,7,7,7,2,7,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,11,7,7,7,2,7,7],[7,0,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,0,5,5,1,5,5,5,5,5,7,7,2,4,4,7,7,7,0,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,0,5,5,1,5,5,5,5,5,7,7,2,4,4,7,7],[7,0,0,6,0,6,0,6,0,6,0,6,0,6,0,0,0,0,0,0,0,6,0,0,0,1,0,0,0,0,0,0,2,4,0,0,7,7,7,0,0,6,0,6,0,6,0,6,0,6,0,6,0,0,0,0,0,0,0,6,0,0,0,1,0,0,0,0,0,0,2,4,0,0,7,7],[7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,0,0,0,0,2,0,0,0,0,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,0,0,0,0,2,0,0,0,0,7],[7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,6,6,6,0,0,6,0,0,0,0,0,0,0,0,2,0,0,0,0,0,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,6,6,6,0,0,6,0,0,0,0,0,0,0,0,2,0,0,0,0,0],[7,0,0,0,0,0,0,0,0,0,0,0,0,0,6,6,6,6,0,0,0,0,0,0,6,0,0,0,0,0,0,0,2,0,0,0,0,8,7,0,1,0,0,0,0,0,0,0,0,0,0,0,6,6,6,6,0,0,0,0,0,0,6,0,0,0,0,0,0,0,2,0,0,0,0,8],[7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,4,4,0,0,8,8,5,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,4,4,0,0,8,8,5],[7,5,5,5,5,5,5,0,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,1,5,5,5,5,2,5,5,5,5,5,5,7,7,5,5,5,5,5,5,0,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,1,5,5,5,5,2,5,5,5,5,5,5,7],[7,7,7,7,7,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,4,4,7,7,7,7,7,7,7,7,7,7,7,7,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,4,4,7,7,7,7,7,7,7],[7,7,7,7,7,7,7,5,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,5,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,7,7,7,7,7,7,7,7,7],[7,7,7,7,7,7,7,7,7,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,7,7,7,7,7,7,7,7,7],[7,7,7,7,7,7,7,7,7,7,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,7,7,7,7,7,7,7,7,7]],this.walkable=BLOCKS.walkable,this.cellH=this.cells.length,this.cellW=this.cells[0].length,this.h=this.cellH*t.h,this.w=this.cellW*t.w,this.camera.setBounds(this.w,this.h),this},tick:function(){},getBlocks:function(t){return t.map(function(t){var i=0|t[1]/this.sheet.h,s=0|t[0]/this.sheet.w;return 0>i||i>this.cellH-1?null:this.cells[i][s]},this)},getBlockEdge:function(t,i){var s=i?this.sheet.h:this.sheet.w;return utils.snap(t,s)},render:function(t){var i,s,e,h=game.tw,n=game.th,a=this.sheet.cellW,r=(this.sheet.cellH,0|this.camera.x/h),o=0|this.camera.y/n,c=r+(0|this.camera.w/h)+1,l=o+(0|this.camera.h/n)+1;for(i=o;l>=i;i++)if(!(0>i||i>this.cellH-1))for(s=r;c>=s;s++)s>this.cellW-1||(e=this.cells[i][s],0!==e&&(e>=2&&4>=e&&(e=(0|Date.now()/200%3)+2),e>=8&&10>=e&&(e=(0|Date.now()/400%3)+8),this.sheet.render(t,0|e%a,0|e/a,s*h,i*n)))}},Entity=function(){this.w=10,this.h=10,this.remove=!1,this.falling=!1,this.xo=0,this.yo=0};Entity.prototype={init:function(t,i){return this.x=t,this.y=i,this},hit:function(){},hitBlocks:function(){},tick:function(){return!this.remove},move:function(t,i,s){var e,h,n,a,r,o,c=!1,l=!1;return e=t,h=i,n=this.x+e,a=this.y+h,o=s.getBlocks([[this.x,a],[this.x,a+(this.h-1)],[this.x+(this.w-1),a],[this.x+(this.w-1),a+(this.h-1)]]),0>i&&(o[0]>s.walkable||o[2]>s.walkable)&&(h=s.getBlockEdge((0|a)+s.sheet.h,"VERT")-this.y,l=!0),i>0&&(o[1]>s.walkable||o[3]>s.walkable)&&(h=s.getBlockEdge(a+this.h,"VERT")-this.y-this.h,l=!0),this.y+=h,r=s.getBlocks([[n,this.y],[n,this.y+(this.h-1)],[n+(this.w-1),this.y],[n+(this.w-1),this.y+(this.h-1)]]),0>t&&(r[0]>s.walkable||r[1]>s.walkable)&&(e=s.getBlockEdge(n+s.sheet.w)-this.x,c=!0),t>0&&(r[2]>s.walkable||r[3]>s.walkable)&&(e=s.getBlockEdge(n+this.w)-this.x-this.w,c=!0),(c||l)&&this.hitBlocks(c?r:null,l?o:null),this.x+=e,o=s.getBlocks([[this.x,this.y+this.h],[this.x+(this.w-1),this.y+this.h]]),this.wasFalling=this.falling,this.falling=o[0]<=s.walkable&&o[1]<=s.walkable?!0:!1,this.xo=0,this.yo=0,[e,h]},render:function(t){t.fillStyle="red",t.fillRect(this.x,this.y,this.w,this.h)}};var Ghoul=function(){this.w=15,this.h=22,this.dir=1,this.speed=3};Ghoul.prototype=new Entity,Ghoul.prototype.init=function(t,i,s){return this.x=t,this.y=i,this.dir=s||1,this.offs={headX:2,headY:-3,bodyX:0,bodyY:5},this},Ghoul.prototype.hit=function(t){t instanceof Spear&&!t.stuck&&(this.remove=!0),t instanceof Trap&&(this.remove=!0)},Ghoul.prototype.tick=function(){return this.y+=Math.sin(Date.now()/100),this.x+=this.speed*this.dir,(this.x<0||this.x>game.ctx.w)&&(this.dir*=-1),!this.remove},Ghoul.prototype.render=function(t){t.strokeStyle="hsl(70, 100%, 50%)",t.shadowColor="hsl(70, 100%, 50%)",t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=10,t.fillStyle="hsl(180, 80%, 50%)",t.fillRect(this.x+this.offs.bodyX,this.y+this.offs.bodyY,12,15),t.fillStyle="hsl(120, 30%, 40%)",t.fillRect(this.x+this.offs.headX*this.dir+3,this.y+this.offs.headY,6,10),t.fillStyle="hsl(120, 40%, 50%)",t.fillRect(this.x+2,this.y+20,8,3),t.fillRect(this.x+4,this.y+11,3,5)};var Player=function(){this.w=12,this.h=23,this.vel=[0,0],this.acc=[0,0],this.grav=0,this.friction=.75,this.falling=!0,this.onLadder=!1,this.wasOnLadder=!1,this.dir=1,this.trapLaunch=-1};Player.prototype=new Entity,Player.prototype.init=function(t,i){return this.x=t,this.y=i,this.initpos=[t,i],this.projectiles=[],this.traps=[],this.offs={headX:2,headY:-3,bodyX:0,bodyY:5},this},Player.prototype.tick=function(t,i){var s=.9;this.projectiles=this.projectiles.filter(function(t){return t.tick(i)}),this.traps=this.traps.filter(function(t){return t.tick(i)}),t.isDown("up")&&(this.inWater||this.onLadder&&!this.onTopOfLadder?this.acc[1]-=s:this.falling||(audio.sfx.jump(),this.acc[1]=-i.sheet.h-1,this.vel[1]=0,this.falling=!0)),t.isDown("down")&&(t.isDown("fire")?this.trapLaunch<0?this.trapLaunch=20:-1===--this.trapLaunch&&(this.trapLaunch=1e3,this.traps.push((new Trap).init(this.x,this.y-2-24))):(this.trapLaunch=-1,this.acc[1]+=s)),t.isDown("left")&&(this.acc[0]-=s,this.dir=-1),t.isDown("right")&&(this.acc[0]+=s,this.dir=1),t.pressed("fire")&&(this.projectiles.push((new Spear).init(this.x,this.y,this.dir)),audio.sfx.shoot()),this.tickVelocity(),this.move(this.xo,this.yo,i),this.checkBlocks(i)},Player.prototype.tickVelocity=function(){this.grav=this.falling?this.grav+.25:0,this.vel=[this.vel[0]+this.acc[0],this.vel[1]+this.acc[1]+this.grav],this.vel=[this.vel[0]*this.friction,this.vel[1]*this.friction],this.acc=[0,0],Math.abs(this.vel[0])<.01&&(this.vel[0]=0),Math.abs(this.vel[1])<.01&&(this.vel[1]=0),this.xo+=this.vel[0],this.yo+=this.vel[1]},Player.prototype.hitSpear=function(t){t.stuck?(this.onLadder=!0,this.falling=!1,this.y+this.h-t.y<10&&(this.onTopOfLadder=!0,this.y=t.y-this.h)):this.onTopOfLadder=!1},Player.prototype.isMoving=function(){return Math.abs(this.vel[0])>.3},Player.prototype.hitBlocks=function(t,i){(t&&t.indexOf(BLOCKS.type.LAVA)>-1||i&&i.indexOf(BLOCKS.type.LAVA)>-1)&&(this.x=this.initpos[0],this.y=this.initpos[1])},Player.prototype.checkBlocks=function(t){this.wasOnLadder=this.onLadder;var i=t.getBlocks([[this.x,this.y],[this.x,this.y+(this.h-1)],[this.x+(this.w-1),this.y],[this.x+(this.w-1),this.y+(this.h-1)]]);this.onTopOfLadder=!1,i.indexOf(BLOCKS.type.LADDER)>-1?(this.wasOnLadder||i[0]!==BLOCKS.type.LADDER&&i[2]!==BLOCKS.type.LADDER&&(this.y=utils.snap(this.y,t.sheet.h)+(t.sheet.h-this.h),this.onTopOfLadder=!0),this.onLadder=!0,this.falling=!1):this.onLadder=!1,this.inWater=!1,i.indexOf(BLOCKS.type.WATER)>-1&&(this.yo+=4,this.inWater=!0,this.falling=!1),i.indexOf(BLOCKS.type.WATERRIGHT)>-1&&(this.xo+=4,this.inWater=!0),i.indexOf(BLOCKS.type.WATERLEFT)>-1&&(this.xo-=4,this.inWater=!0)},Player.prototype.render=function(t){t.shadowBlur=0,this.projectiles.forEach(function(i){return i.render(t)}),this.traps.forEach(function(i){return i.render(t)}),t.strokeStyle="#000",t.fillStyle="hsl(10, 70%, 30%)",t.fillRect(this.x+this.offs.bodyX,this.y+this.offs.bodyY,12,15),t.strokeRect(this.x+this.offs.bodyX,this.y+this.offs.bodyY,12,15),t.fillStyle="hsl(20, 30%, 40%)",t.fillRect(this.x+this.offs.headX*this.dir+3,this.y+this.offs.headY,6,10),t.strokeRect(this.x+this.offs.headX*this.dir+3,this.y+this.offs.headY,6,10),t.fillStyle="hsl(55, 100%, 50%)",this.isMoving()?0===(0|Date.now()/80)%2?(t.fillRect(this.x+2,this.y+20,3,3),t.fillRect(this.x+8,this.y+20,3,3),t.fillRect(this.x+4,this.y+11,3,5)):(t.fillRect(this.x+4,this.y+20,4,3),t.fillRect(this.x+5,this.y+11,3,5)):(t.fillRect(this.x+2,this.y+20,3,3),t.fillRect(this.x+8,this.y+20,3,3),t.fillRect(this.x+4,this.y+11,3,5))};var Spear=function(){this.w=15,this.h=4,this.speed=8,this.dir=-1,this.life=200,this.remove=!1,this.stuck=!1,this.x=0,this.y=0};Spear.prototype=new Entity,Spear.prototype.init=function(t,i,s){return this.x=t,this.y=i,this.dir=s,this},Spear.prototype.tick=function(t){if(!this.stuck){var i=this.speed*this.dir,s=this.move(i,this.yo,t);0===s[0]&&(this.stuck=!0)}return this.life--<0&&(this.remove=!0),!this.remove},Spear.prototype.hit=function(t){t instanceof Spear?this.stuck=!0:this.remove=!0},Spear.prototype.render=function(t){t.fillStyle="hsl(55, 100%, 50%)",t.strokeStyle="#000",t.lineWidth=1,t.fillRect(this.x,this.y+1,this.w,this.h-2),t.fillRect(this.x+(this.dir<0?10:this.w-12),this.y,2,this.h),t.strokeRect(this.x-1,this.y,this.w+2,this.h)};var Camera={x:0,y:0,xRange:80,yRange:100,init:function(t,i,s,e,h){return this.entity=t,this.w=e,this.h=h,this.x=i,this.y=s,this.track(t),this},setBounds:function(t,i){this.bounds=[t,i]},track:function(t){var i=t||this.entity;this.x=i.x-this.w/2+i.w/2,this.y=i.y-this.h/2,this.constrainToBounds()},constrainToBounds:function(){this.x<0&&(this.x=0),this.x>0&&this.bounds&&this.x+this.w>this.bounds[0]&&(this.x=this.bounds[0]-this.w),this.y<0&&(this.y=0),this.y>0&&this.bounds&&this.y+this.h>this.bounds[1]&&(this.y=this.bounds[1]-this.h)},tick:function(){var t=this.entity,i={x:this.x+this.w/2,y:this.y+this.h/2},s=this.xRange,e=this.yRange;t.x<i.x-s&&(this.x=t.x-this.w/2+s),t.x+t.w>i.x+s&&(this.x=t.x+t.w-this.w/2-s),t.y<i.y-e&&(this.y=t.y-this.h/2+e),t.y+t.h>i.y+e&&(this.y=t.y+t.h-this.h/2-e),this.constrainToBounds()},render:function(t,i){var s=this;t.save(),t.translate(-Math.round(this.x),-Math.round(this.y)),i.reduce(function(t,i){return Array.isArray(i)?t.concat(i):(t.push(i),t)},[]).filter(function(t){return t.repeat||!(t.x+t.w<s.x||t.y+t.h<s.y||t.x>s.x+s.w/s.zoom||t.y>s.y+s.h/s.zoom)}).forEach(function(i){i.render(t,s)}),t.restore()}};window.Screen=window.Screen||{},Screen.title={init:function(){return this},tick:function(){},render:function(t){t.fillStyle="#000",t.fillRect(0,0,t.w,t.h),t.fillStyle="#888",t.font="10pt monospace",t.fillText("abcdefghijklmnopqrstuvwxyz",.5*t.w,.5*t.h)}},window.Screen=window.Screen||{},Screen.level={init:function(){var t=makeSheet(game.res.tiles,game.tw,game.th);return this.player=(new Player).init(100,100),this.camera=Camera.init(this.player,0,0,game.ctx.w,game.ctx.h),this.map=Map.init(t,this.camera),this.ghouls=[(new Ghoul).init(200,285)],this},tick:function(t){this.camera.tick(),this.player.tick(t,this.map),this.ghouls=this.ghouls.filter(function(t){return t.tick()}),Math.random()<.01&&this.ghouls.length<15&&this.ghouls.push((new Ghoul).init(5,[110,280,420][0|3*Math.random()],1)),utils.checkCollisions([this.ghouls,this.player.projectiles]),utils.checkCollisions([this.ghouls,this.player.traps]),utils.checkCollision(this.player,this.player.projectiles,"hitSpear")},render:function(t){t.clearRect(0,0,t.w,t.h),t.fillStyle="#550",t.font="10pt monospace",t.fillText("abcdefghijklmnopqrstuvwxyz",.5*t.w,.5*t.h),this.camera.render(t,[this.map,this.ghouls,this.player])}};var Input={keys:{37:{wasDown:!1,isDown:!1},38:{wasDown:!1,isDown:!1},39:{wasDown:!1,isDown:!1},40:{wasDown:!1,isDown:!1},32:{wasDown:!1,isDown:!1}},actions:{up:38,right:39,down:40,left:37,fire:32},init:function(){function t(t,s){i.keys[t]&&(i.keys[t].wasDown=i.keys[t].isDown,i.keys[t].isDown=s)}var i=this;return document.addEventListener("keydown",function(i){t(i.keyCode,!0)},!1),document.addEventListener("keyup",function(i){t(i.keyCode,!1)},!1),this},tick:function(){var t;for(t in this.keys)this.keys[t].wasDown=this.keys[t].isDown},isDown:function(t){return this.keys[this.actions[t]].isDown},wasDown:function(t){return this.keys[this.actions[t]].wasDown},pressed:function(t){return this.isDown(t)&&!this.wasDown(t)}},game={tw:20,th:24,res:{},init:function(){this.ctx=this.createCanvas(),this.res={tiles:GEN.tiles(this.tw,this.th)},audio.init(),this.input=Input.init(),this.reset(),this.run()},setScreen:function(t){this.screen=t.init()},createCanvas:function(){var t=document.createElement("canvas");t.setAttribute("id","board"),t.setAttribute("width",720),t.setAttribute("height",405),document.body.appendChild(t);var i=t.getContext("2d");if(!i)throw alert("Could not get 2D context."),new Error("lol, no canvas dude.");return i.imageSmoothingEnabled=!1,i.mozImageSmoothingEnabled=!1,i.webkitImageSmoothingEnabled=!1,i.w=i.canvas.width,i.h=i.canvas.height,i},createChars:function(){},reset:function(){this.setScreen(Screen.level)},run:function(){this.screen.tick(this.input),this.input.tick(),this.screen.render(this.ctx),window.requestAnimationFrame(function(){game.run(Date.now())})}};