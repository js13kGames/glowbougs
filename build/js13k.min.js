function makeSheet(t,i,e){return{w:i,h:e,cellW:Math.ceil(t.width/i),cellH:Math.ceil(t.height/e),render:function(s,h,n,a,r){s.drawImage(t,h*i,n*e,i,e,a,r,i,e)}}}var utils={snap:function(t,i){return Math.floor(t/i)*i},checkCollision:function(t,i,e){var s,h,n,a,r=t,e=e||"hit",o=i.length;for(s=0;o>s;s++)h=i[s],n=r.x+(r.xbb||0),a=h.x+(h.xbb||0),r!==h&&n+r.w>=a&&n<=a+h.w&&r.y+r.h>=h.y&&r.y<=h.y+h.h&&(r[e]&&r[e](h),h[e]&&h[e](r))},checkCollisions:function(t,i){var e,s,h,n,i=i||"hit",a=t.reduce(function(t,i){return Array.isArray(i)?t.concat(i):(t.push(i),t)},[]),r=a.length;for(e=0;r-1>e;e++)for(h=a[e],s=e+1;r>s;s++)n=a[s],h!==n&&h.x+h.w>=n.x&&h.x<=n.x+n.w&&h.y+h.h>=n.y&&h.y<=n.y+n.h&&(h[i]&&h[i](n),n[i]&&n[i](h))}};window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame;var GEN={tiles:function(t,i){var e,s,h,n,a,r,o,c=8;for(o=document.createElement("canvas"),o.setAttribute("width",c*t),o.setAttribute("height",1*i),r=o.getContext("2d"),a=r.createImageData(o.width,o.height),e=0;c>e;e++)for(h=0;i>h;h++)for(s=0;t>s;s++){var l=4*s+4*h*o.width+4*e*t,u=16711935,w=255;switch(w=255-(0|96*Math.random()),e){case 5:u=7426359,(3&3*s*s+41*s>>2)+8>h?u=6990400:(3&3*s*s+41*s>>2)+9>h&&(w=2*w/3);break;case 7:u=7426359;break;case 6:u=8355711;break;case 1:u=Math.random()<.15?5298487:-1,(1==(s+16*(h>>2))%8||0==h%8)&&(u=14795897);break;case 2:case 3:case 4:u=4948931;var d=h%12-4*(e-2);0>d&&(d+=12),Math.abs(0|5*Math.sin(s/2))===d&&(u=16777215)}if(-1==u)a.data[l+0]=0,a.data[l+1]=0,a.data[l+2]=0,a.data[l+3]=0;else{var y=(255&u>>16)*w/255<<16|(255&u>>8)*w/255<<8|(255&u)*w/255;a.data[l+0]=255&y>>16,a.data[l+1]=255&y>>8,a.data[l+2]=255&y,a.data[l+3]=255}}for(n=0;n<o.width*o.height;n++);return r.putImageData(a,0,0),o}};!function(){var t=new(window.AudioContext||window.webkitAudioContext);window.audio={sfx:{jump:function(){var i=t.currentTime,e=t.createOscillator();e.connect(audio.master),e.type="square",e.frequency.value=0,e.frequency.setValueAtTime(200,0),e.frequency.linearRampToValueAtTime(400,i+.01),e.start(0),e.stop(i+.01)}},init:function(){this.master=t.createGain(),this.master.gain.value=.5,this.master.connect(t.destination)},stop:function(){this.osc.stop(t.currentTime)}}}();var BLOCKS={walkable:4,type:{LADDER:1,WATER:2,WATERRIGHT:3,WATERLEFT:4}};window.BLOCKS=BLOCKS;var Map={x:0,y:0,init:function(t,i){return this.sheet=t,this.camera=i,this.cells=[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,7,7],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,7,7],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,7,7],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,1,5,5,0,0,0,0,0,0,0,0,0,0,0,7,7],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,7,1,7,7,5,0,0,0,0,0,0,0,0,0,0,0,7],[5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,7,7,1,7,7,7,0,0,0,0,0,0,0,0,0,0,0,7],[7,0,0,5,5,5,5,5,0,5,5,5,5,5,5,5,5,5,5,5,7,7,1,7,7,7,5,5,5,5,5,5,2,5,5,5,5,7],[7,0,0,7,7,7,7,7,0,7,7,7,7,7,7,7,7,7,7,7,7,7,1,7,7,7,7,7,7,7,7,7,2,7,7,7,7,7],[0,5,0,0,0,6,0,6,0,6,0,6,0,6,0,6,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,2,0,0,0,7,7],[5,0,5,0,0,0,0,0,0,0,0,0,0,0,0,0,6,6,0,0,0,0,1,0,0,0,0,0,0,0,0,0,2,0,0,5,7,7],[7,0,0,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,6,6,1,0,0,0,0,0,0,3,3,3,2,7,7],[7,0,0,0,5,0,0,0,0,0,0,0,0,0,0,0,0,6,6,6,0,0,0,0,0,1,0,0,0,0,0,0,7,7,7,2,7,7],[7,0,0,0,0,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,5,7,7,7,2,7,7],[7,0,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,0,5,5,1,5,5,5,5,5,7,7,2,4,4,7,7],[7,0,0,6,0,6,0,6,0,6,0,6,0,6,0,0,0,0,0,0,0,6,0,0,0,1,0,0,0,0,0,0,2,4,0,0,7,7],[7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,0,0,0,0,2,0,0,0,0,7],[7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,6,6,0,0,6,0,0,0,0,0,0,0,0,2,0,0,0,0,0],[7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,0,0,0,0,0,2,0,0,0,0,0],[7,0,0,0,0,0,0,0,0,0,0,0,0,0,6,6,6,6,0,0,0,0,0,0,0,0,0,0,0,0,2,4,4,0,0,0,0,5],[7,5,5,5,5,5,5,0,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,2,5,5,5,5,5,5,7],[7,7,7,7,7,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,4,7,7,7,7,7,7,7],[7,7,7,7,7,7,7,5,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,7,7,7,7,7,7,7,7,7],[7,7,7,7,7,7,7,7,7,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,7,7,7,7,7,7,7,7,7],[7,7,7,7,7,7,7,7,7,7,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,7,7,7,7,7,7,7,7,7]],this.walkable=BLOCKS.walkable,this.cellH=this.cells.length,this.cellW=this.cells[0].length,this.h=this.cellH*t.h,this.w=this.cellW*t.w,this.camera.setBounds(this.w,this.h),this},tick:function(){},getBlocks:function(t){return t.map(function(t){var i=0|t[1]/this.sheet.h,e=0|t[0]/this.sheet.w;return 0>i||i>this.cellH-1?null:this.cells[i][e]},this)},getBlockEdge:function(t,i){var e=i?this.sheet.h:this.sheet.w;return utils.snap(t,e)},render:function(t){var i,e,s,h=game.tw,n=game.th,a=this.sheet.cellW,r=(this.sheet.cellH,0|this.camera.x/h),o=0|this.camera.y/n,c=r+(0|this.camera.w/h)+1,l=o+(0|this.camera.h/n)+1;for(i=o;l>=i;i++)if(!(0>i||i>this.cellH-1))for(e=r;c>=e;e++)e>this.cellW-1||(s=this.cells[i][e],0!==s&&(s>=2&&4>=s&&(s=(0|Date.now()/200%3)+2),this.sheet.render(t,0|s%a,0|s/a,e*h,i*n)))}},Entity=function(){this.w=10,this.h=10,this.remove=!1,this.falling=!1,this.xo=0,this.yo=0};Entity.prototype={init:function(t,i){return this.x=t,this.y=i,this},hit:function(){},hitBlocks:function(){},tick:function(){return!this.remove},move:function(t,i,e){var s,h,n,a,r,o,c=!1,l=!1;return s=t,h=i,n=this.x+s,a=this.y+h,o=e.getBlocks([[this.x,a],[this.x,a+(this.h-1)],[this.x+(this.w-1),a],[this.x+(this.w-1),a+(this.h-1)]]),0>i&&(o[0]>e.walkable||o[2]>e.walkable)&&(h=e.getBlockEdge((0|a)+e.sheet.h,"VERT")-this.y,l=!0),i>0&&(o[1]>e.walkable||o[3]>e.walkable)&&(h=e.getBlockEdge(a+this.h,"VERT")-this.y-this.h,l=!0),this.y+=h,r=e.getBlocks([[n,this.y],[n,this.y+(this.h-1)],[n+(this.w-1),this.y],[n+(this.w-1),this.y+(this.h-1)]]),0>t&&(r[0]>e.walkable||r[1]>e.walkable)&&(s=e.getBlockEdge(n+e.sheet.w)-this.x,c=!0),t>0&&(r[2]>e.walkable||r[3]>e.walkable)&&(s=e.getBlockEdge(n+this.w)-this.x-this.w,c=!0),(c||l)&&this.hitBlocks(c?r:null,l?o:null),this.x+=s,o=e.getBlocks([[this.x,this.y+this.h],[this.x+(this.w-1),this.y+this.h]]),this.wasFalling=this.falling,this.falling=o[0]<=e.walkable&&o[1]<=e.walkable?!0:!1,this.xo=0,this.yo=0,[s,h]},render:function(t){t.fillStyle="red",t.fillRect(this.x,this.y,this.w,this.h)}};var Ghoul=function(){this.w=15,this.h=22};Ghoul.prototype=new Entity,Ghoul.prototype.hit=function(){this.remove=!0};var Player=function(){this.w=12,this.h=23,this.vel=[0,0],this.acc=[0,0],this.grav=0,this.friction=.75,this.falling=!0,this.onLadder=!1,this.wasOnLadder=!1,this.dir=1};Player.prototype=new Entity,Player.prototype.init=function(t,i){return this.x=t,this.y=i,this.projectiles=[],this},Player.prototype.tick=function(t,i){var e=.9;this.projectiles=this.projectiles.filter(function(t){return t.tick(i)}),t.isDown("up")&&(this.inWater||this.onLadder&&!this.onTopOfLadder?this.acc[1]-=e:this.falling||(audio.sfx.jump(),this.acc[1]=-i.sheet.h-1,this.vel[1]=0,this.falling=!0)),t.isDown("down")&&(this.acc[1]+=e),t.isDown("left")&&(this.acc[0]-=e,this.dir=-1),t.isDown("right")&&(this.acc[0]+=e,this.dir=1),t.pressed("fire")&&this.projectiles.push((new Spear).init(this.x,this.y,this.dir)),this.tickVelocity(),this.move(this.xo,this.yo,i),this.checkBlocks(i)},Player.prototype.tickVelocity=function(){this.grav=this.falling?this.grav+.25:0,this.vel=[this.vel[0]+this.acc[0],this.vel[1]+this.acc[1]+this.grav],this.vel=[this.vel[0]*this.friction,this.vel[1]*this.friction],this.acc=[0,0],Math.abs(this.vel[0])<.01&&(this.vel[0]=0),Math.abs(this.vel[1])<.01&&(this.vel[1]=0),this.xo+=this.vel[0],this.yo+=this.vel[1]},Player.prototype.hitSpear=function(t){t.stuck?(this.onLadder=!0,this.falling=!1,this.y+this.h-t.y<10&&(this.onTopOfLadder=!0,this.y=t.y-this.h)):this.onTopOfLadder=!1},Player.prototype.checkBlocks=function(t){this.wasOnLadder=this.onLadder;var i=t.getBlocks([[this.x,this.y],[this.x,this.y+(this.h-1)],[this.x+(this.w-1),this.y],[this.x+(this.w-1),this.y+(this.h-1)]]);this.onTopOfLadder=!1,i.indexOf(BLOCKS.type.LADDER)>-1?(this.wasOnLadder||i[0]!==BLOCKS.type.LADDER&&i[2]!==BLOCKS.type.LADDER&&(this.y=utils.snap(this.y,t.sheet.h)+(t.sheet.h-this.h),this.onTopOfLadder=!0),this.onLadder=!0,this.falling=!1):this.onLadder=!1,this.inWater=!1,i.indexOf(BLOCKS.type.WATER)>-1&&(this.yo+=4,this.inWater=!0,this.falling=!1),i.indexOf(BLOCKS.type.WATERRIGHT)>-1&&(this.xo+=4,this.inWater=!0),i.indexOf(BLOCKS.type.WATERLEFT)>-1&&(this.xo-=4,this.inWater=!0)},Player.prototype.render=function(t){this.projectiles.forEach(function(i){return i.render(t)}),t.fillStyle="#22f",t.fillRect(this.x,this.y,this.w,this.h)};var Spear=function(){this.w=15,this.h=4,this.speed=8,this.dir=-1,this.life=200,this.falling=!1,this.remove=!1,this.stuck=!1,this.x=0,this.y=0};Spear.prototype=new Entity,Spear.prototype.init=function(t,i,e){return this.x=t,this.y=i,this.dir=e,this},Spear.prototype.tick=function(t){if(!this.stuck){var i=this.speed*this.dir,e=this.move(i,this.yo,t);0===e[0]&&(this.stuck=!0)}return this.life--<0&&(this.remove=!0),!this.remove},Spear.prototype.hit=function(t){t instanceof Spear?this.stuck=!0:this.remove=!0};var Camera={x:0,y:0,xRange:80,yRange:100,init:function(t,i,e,s,h){return this.entity=t,this.w=s,this.h=h,this.x=i,this.y=e,this.track(t),this},setBounds:function(t,i){this.bounds=[t,i]},track:function(t){var i=t||this.entity;this.x=i.x-this.w/2+i.w/2,this.y=i.y-this.h/2,this.constrainToBounds()},constrainToBounds:function(){this.x<0&&(this.x=0),this.x>0&&this.bounds&&this.x+this.w>this.bounds[0]&&(this.x=this.bounds[0]-this.w),this.y<0&&(this.y=0),this.y>0&&this.bounds&&this.y+this.h>this.bounds[1]&&(this.y=this.bounds[1]-this.h)},tick:function(){var t=this.entity,i={x:this.x+this.w/2,y:this.y+this.h/2},e=this.xRange,s=this.yRange;t.x<i.x-e&&(this.x=t.x-this.w/2+e),t.x+t.w>i.x+e&&(this.x=t.x+t.w-this.w/2-e),t.y<i.y-s&&(this.y=t.y-this.h/2+s),t.y+t.h>i.y+s&&(this.y=t.y+t.h-this.h/2-s),this.constrainToBounds()},render:function(t,i){var e=this;t.save(),t.translate(-Math.round(this.x),-Math.round(this.y)),i.reduce(function(t,i){return Array.isArray(i)?t.concat(i):(t.push(i),t)},[]).filter(function(t){return t.repeat||!(t.x+t.w<e.x||t.y+t.h<e.y||t.x>e.x+e.w/e.zoom||t.y>e.y+e.h/e.zoom)}).forEach(function(i){i.render(t,e)}),t.restore()}};window.Screen=window.Screen||{},Screen.title={init:function(){return this},tick:function(){},render:function(t){t.fillStyle="#000",t.fillRect(0,0,t.w,t.h),t.fillStyle="#888",t.font="10pt monospace",t.fillText("abcdefghijklmnopqrstuvwxyz",.5*t.w,.5*t.h)}},window.Screen=window.Screen||{},Screen.level={init:function(){var t=makeSheet(game.res.tiles,game.tw,game.th);return this.player=(new Player).init(100,100),this.camera=Camera.init(this.player,0,0,game.ctx.w,game.ctx.h),this.map=Map.init(t,this.camera),this.ghouls=[(new Ghoul).init(200,280)],this},tick:function(t){this.camera.tick(),this.player.tick(t,this.map),this.ghouls=this.ghouls.filter(function(t){return t.tick()}),utils.checkCollisions([this.ghouls,this.player.projectiles]),utils.checkCollision(this.player,this.player.projectiles,"hitSpear")},render:function(t){t.clearRect(0,0,t.w,t.h);var i=t.createLinearGradient(0,0,0,t.h);i.addColorStop(0,"hsl(30, 50%, 25%)"),i.addColorStop(1,"hsl(20, 50%, 00%)"),t.fillStyle=i,t.fillStyle="#888",t.font="10pt monospace",t.fillText("abcdefghijklmnopqrstuvwxyz",.5*t.w,.5*t.h),this.camera.render(t,[this.map,this.ghouls,this.player])}};var Input={keys:{37:{wasDown:!1,isDown:!1},38:{wasDown:!1,isDown:!1},39:{wasDown:!1,isDown:!1},40:{wasDown:!1,isDown:!1},32:{wasDown:!1,isDown:!1}},actions:{up:38,right:39,down:40,left:37,fire:32},init:function(){function t(t,e){i.keys[t]&&(i.keys[t].wasDown=i.keys[t].isDown,i.keys[t].isDown=e)}var i=this;return document.addEventListener("keydown",function(i){t(i.keyCode,!0)},!1),document.addEventListener("keyup",function(i){t(i.keyCode,!1)},!1),this},tick:function(){var t;for(t in this.keys)this.keys[t].wasDown=this.keys[t].isDown},isDown:function(t){return this.keys[this.actions[t]].isDown},wasDown:function(t){return this.keys[this.actions[t]].wasDown},pressed:function(t){return this.isDown(t)&&!this.wasDown(t)}},game={tw:20,th:24,res:{},init:function(){this.ctx=this.createCanvas(),this.res={tiles:GEN.tiles(this.tw,this.th)},audio.init(),this.input=Input.init(),this.reset(),this.run()},setScreen:function(t){this.screen=t.init()},createCanvas:function(){var t=document.createElement("canvas");t.setAttribute("id","board"),t.setAttribute("width",720),t.setAttribute("height",405),document.body.appendChild(t);var i=t.getContext("2d");if(!i)throw alert("Could not get 2D context."),new Error("lol, no canvas dude.");return i.imageSmoothingEnabled=!1,i.mozImageSmoothingEnabled=!1,i.webkitImageSmoothingEnabled=!1,i.w=i.canvas.width,i.h=i.canvas.height,i},createChars:function(){},reset:function(){this.setScreen(Screen.level)},run:function(){this.screen.tick(this.input),this.input.tick(),this.screen.render(this.ctx),window.requestAnimationFrame(function(){game.run(Date.now())})}};